{% extends 'base.html' %}

{% block titulo %}
Funcionarios
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
    <h3><i class="fas fa-user-tie"></i> Gestión de Funcionarios</h3>
    
    <!-- Tarjeta principal -->
    <div class="card shadow">
        <!-- Header simplificado -->
        <div class="card-header bg-primary text-white">
            <button type="button" class="btn btn-light" id="btnAgregar">
                <i class="fas fa-plus-circle"></i> Agregar Nuevo Funcionario
            </button>
        </div>

        <!-- Cuerpo de la tarjeta con tabla -->
        <div class="card-body">
            <!-- Tabla de funcionarios -->
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered w-100" id="tbl">
                    <thead class="thead-dark">
                        <tr>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Cédula</th>
                            <th>Cargo</th>
                            <th>Teléfono</th>
                            <th>Género</th>
                            <th>Ciudad</th>
                            <th>Estado</th>
                            <th>Matrícula</th>
                            <th>Especialidades</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar al funcionario <strong id="nombreFuncionarioEliminar"></strong>?</p>
                <p class="text-danger"><small><i class="fas fa-exclamation-circle"></i> Esta acción no se puede deshacer.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Vista Previa Completa del Funcionario -->
<div class="modal fade" id="modalVistaFuncionario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-user-circle"></i> Ficha Completa del Funcionario</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="contenidoVistaFuncionario">
                <!-- Se carga dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="btnImprimirFicha">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal con Wizard -->
<div class="modal fade" id="modalFormulario" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modalTitle">Registro de Funcionario</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      
      <div class="modal-body">
        <!-- Indicadores de pasos -->
        <div class="stepwizard mb-4">
          <div class="stepwizard-row">
            <div class="stepwizard-step">
              <button type="button" class="btn btn-primary btn-circle" data-step="1">1</button>
              <p><small>Datos Personales</small></p>
            </div>
            <div class="stepwizard-step">
              <button type="button" class="btn btn-default btn-circle" data-step="2">2</button>
              <p><small>Contacto</small></p>
            </div>
            <div class="stepwizard-step">
              <button type="button" class="btn btn-default btn-circle" data-step="3">3</button>
              <p><small>Académico</small></p>
            </div>
            <div class="stepwizard-step">
              <button type="button" class="btn btn-default btn-circle" data-step="4">4</button>
              <p><small>Laboral</small></p>
            </div>
            <div class="stepwizard-step" id="step5Indicator" style="display:none;">
              <button type="button" class="btn btn-default btn-circle" data-step="5">5</button>
              <p><small>Especialista</small></p>
            </div>
          </div>
        </div>

        <form id="formFuncionario">
          <input type="hidden" id="txtIdPersona">
          <input type="hidden" id="txtIdFuncionario">
          
          <!-- PASO 1: Datos Personales -->
          <div class="wizard-step" data-step="1">
            <h5 class="text-primary mb-3">Datos Personales</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtNombre">Nombre: <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" placeholder="Ingrese el nombre" id="txtNombre" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtApellido">Apellido: <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" placeholder="Ingrese el apellido" id="txtApellido" required>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtCedula">Cédula: <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" placeholder="Ingrese la cédula" id="txtCedula" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtFecha_nacimiento">Fecha de nacimiento:</label>
                  <input type="date" class="form-control" id="txtFecha_nacimiento">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <input type="hidden" id="id_genero">
                  <label for="txtGenero">Sexo:</label>
                  <input type="text" class="form-control" placeholder="Seleccione el sexo" id="txtGenero">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <input type="hidden" id="id_estado_civil">
                  <label for="txtEstado_civil">Estado civil:</label>
                  <input type="text" class="form-control" placeholder="Seleccione el estado civil" id="txtEstado_civil">
                </div>
              </div>
            </div>
          </div>

          <!-- PASO 2: Contacto -->
          <div class="wizard-step" data-step="2" style="display:none;">
            <h5 class="text-primary mb-3">Datos de Contacto</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtTelefono">Teléfono: <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" placeholder="Ingrese el teléfono" id="txtTelefono" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtCorreo">Correo electrónico:</label>
                  <input type="email" class="form-control" placeholder="Ingrese el correo" id="txtCorreo">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label for="txtDomicilio">Domicilio:</label>
                  <input type="text" class="form-control" placeholder="Ingrese el domicilio" id="txtDomicilio">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <input type="hidden" id="id_ciudad">
                  <label for="txtCiudad">Ciudad de residencia:</label>
                  <input type="text" class="form-control" placeholder="Seleccione la ciudad" id="txtCiudad">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <input type="hidden" id="id_ciudad_nacimiento">
                  <label for="txtCiudad_nacimiento">Ciudad de nacimiento:</label>
                  <input type="text" class="form-control" placeholder="Seleccione la ciudad de nacimiento" id="txtCiudad_nacimiento">
                </div>
              </div>
            </div>
          </div>

          <!-- PASO 3: Académico -->
          <div class="wizard-step" data-step="3" style="display:none;">
            <h5 class="text-primary mb-3">Datos Académicos y Profesionales</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <input type="hidden" id="id_nivel_instruccion">
                  <label for="txtNivel_instruccion">Nivel de instrucción:</label>
                  <input type="text" class="form-control" placeholder="Seleccione nivel de instrucción" id="txtNivel_instruccion">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <input type="hidden" id="id_profesion">
                  <label for="txtProfesion">Profesión/Ocupación:</label>
                  <input type="text" class="form-control" placeholder="Seleccione profesión" id="txtProfesion">
                </div>
              </div>
            </div>
          </div>

          <!-- PASO 4: Laboral -->
<div class="wizard-step" data-step="4" style="display:none;">
  <h5 class="text-primary mb-3">Datos Laborales</h5>
  <div class="row">
    <div class="col-md-6">
      <div class="form-group">
        <input type="hidden" id="id_cargo">
        <label for="txtCargo">Cargo:</label>
        <input type="text" class="form-control" placeholder="Seleccione el cargo" id="txtCargo">
      </div>
    </div>

    <div class="col-md-6">
      <div class="form-group">
        <label>&nbsp;</label>
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="chkActivo" checked>
          <label class="custom-control-label" for="chkActivo">
            <strong>Funcionario Activo</strong>
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <!-- NUEVO: Checkbox Es Especialista -->
  <div class="row">
    <div class="col-md-12">
      <div class="custom-control custom-switch">
        <input type="checkbox" class="custom-control-input" id="chkEsEspecialista">
        <label class="custom-control-label" for="chkEsEspecialista">
          <strong>¿Es especialista (Psicólogo/a)?</strong>
        </label>
      </div>
    </div>
  </div>
</div>

          <!-- PASO 5: Datos de Especialista (solo si cargo es especialista) -->
          <div class="wizard-step" data-step="5" style="display:none;">
            <h5 class="text-success mb-3">Datos de Especialista (Psicólogo/a)</h5>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> Complete estos datos solo si el funcionario es un profesional de la salud mental.
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtMatricula">Matrícula Profesional: <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" placeholder="Ej: MAT-PSI-001" id="txtMatricula">
                  <small class="form-text text-muted">Número de matrícula del Consejo Profesional</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="txtColorAgenda">Color en Agenda:</label>
                  <input type="color" class="form-control" id="txtColorAgenda" value="#3498db" style="height: 45px;">
                  <small class="form-text text-muted">Color para identificar en el calendario</small>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12">
                <div class="form-group">
                  <label>Especialidades: <span class="text-danger">*</span></label>
                  <small class="form-text text-muted mb-2">Seleccione una o más especialidades (mínimo 1)</small>
                  <div class="border rounded p-3" id="contenedorEspecialidades" style="max-height: 300px; overflow-y: auto;">
                    <!-- Se cargan dinámicamente los checkboxes -->
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="btnAnterior">
          <i class="fas fa-arrow-left"></i> Anterior
        </button>
        <button type="button" class="btn btn-primary" id="btnSiguiente">
          Siguiente <i class="fas fa-arrow-right"></i>
        </button>
        <button type="button" class="btn btn-success" id="btnGuardar" style="display:none;">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.stepwizard-row {
  display: flex;
  justify-content: space-between;
  position: relative;
}

.stepwizard-row:before {
  content: "";
  position: absolute;
  top: 20px;
  left: 10%;
  right: 10%;
  height: 2px;
  background-color: #ddd;
  z-index: 0;
}

.stepwizard-step {
  text-align: center;
  flex: 1;
  position: relative;
}

.stepwizard-step p {
  margin-top: 10px;
  font-size: 12px;
}

.btn-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 16px;
  font-weight: bold;
  position: relative;
  z-index: 2;
  background-color: white;
}

.btn-circle.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-circle.btn-success {
  background-color: #28a745;
  color: white;
}

/* Estilos para checkboxes de especialidades */
#contenedorEspecialidades .custom-control {
  padding: 8px;
  border-bottom: 1px solid #eee;
}

#contenedorEspecialidades .custom-control:hover {
  background-color: #f8f9fa;
}

#contenedorEspecialidades .custom-control:last-child {
  border-bottom: none;
}
</style>
<!-- Modal Buscar Género -->
<div class="modal" id="modalBuscarGenero">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Sexo</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblGenero">
            <thead>
              <tr>
                <th>Sexo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Buscar Estado Civil -->
<div class="modal" id="modalBuscarEstadoCivil">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Estado Civil</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblEstadoCivil">
            <thead>
              <tr>
                <th>Estado Civil</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Buscar Ciudad -->
<div class="modal" id="modalBuscarCiudad">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Ciudad de Residencia</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblCiudad">
            <thead>
              <tr>
                <th>Ciudad</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Buscar Ciudad de Nacimiento -->
<div class="modal" id="modalBuscarCiudadNacimiento">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Ciudad de Nacimiento</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblCiudadNacimiento">
            <thead>
              <tr>
                <th>Ciudad</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Buscar Nivel de Instrucción -->
<div class="modal" id="modalBuscarNivelInstruccion">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Nivel de Instrucción</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblNivelInstruccion">
            <thead>
              <tr>
                <th>Nivel de Instrucción</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Buscar Profesión -->
<div class="modal" id="modalBuscarProfesion">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Profesión</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblProfesion">
            <thead>
              <tr>
                <th>Profesión/Ocupación</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Buscar Cargo -->
<div class="modal" id="modalBuscarCargo">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Seleccionar Cargo</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered w-100" id="tblCargo">
            <thead>
              <tr>
                <th>Cargo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>



    
    <div class="row mt-4 d-none" id="rowAlerta">
      <div class="col col-md-12">
        <div class="alert alert-success">
          <strong>Registro Exitoso!</strong>
          <div class="row" id="mostrarAlerta"></div>
        </div>
      </div>
    </div>
</div>

{% endblock %}


















{% block js %}

<script>
// ==========================================
// CONSTANTES Y CONFIGURACIÓN
// ==========================================
const CSRFToken = "{{ csrf_token() }}" || null;
let currentStep = 1;

// ==========================================
// CONFIGURACIÓN DE BÚSQUEDAS UNIFICADAS
// ==========================================
const SEARCH_CONFIGS = {
  genero: {
    modalId: 'modalBuscarGenero',
    tableId: 'tblGenero',
    endpoint: '/api/v1/generos',
    inputId: 'txtGenero',
    hiddenId: 'id_genero',
    dataKey: 'id',  // ← CORREGIDO: usa 'id' genérico
    title: 'Seleccionar Sexo'
  },
  estadoCivil: {
    modalId: 'modalBuscarEstadoCivil',
    tableId: 'tblEstadoCivil',
    endpoint: '/api/v1/estados-civiles',
    inputId: 'txtEstado_civil',
    hiddenId: 'id_estado_civil',
    dataKey: 'id',  // ← CORREGIDO: usa 'id' genérico
    title: 'Seleccionar Estado Civil'
  },
  ciudad: {
    modalId: 'modalBuscarCiudad',
    tableId: 'tblCiudad',
    endpoint: '/api/v1/ciudades',
    inputId: 'txtCiudad',
    hiddenId: 'id_ciudad',
    dataKey: 'id',  // ← CORREGIDO: usa 'id' genérico
    title: 'Seleccionar Ciudad de Residencia'
  },
  ciudadNacimiento: {
    modalId: 'modalBuscarCiudadNacimiento',
    tableId: 'tblCiudadNacimiento',
    endpoint: '/api/v1/ciudades',
    inputId: 'txtCiudad_nacimiento',
    hiddenId: 'id_ciudad_nacimiento',
    dataKey: 'id',  // ← CORREGIDO: usa 'id' genérico
    title: 'Seleccionar Ciudad de Nacimiento'
  },
  nivelInstruccion: {
    modalId: 'modalBuscarNivelInstruccion',
    tableId: 'tblNivelInstruccion',
    endpoint: '/api/v1/niveles-instruccion',
    inputId: 'txtNivel_instruccion',
    hiddenId: 'id_nivel_instruccion',
    dataKey: 'id',  // ← CORREGIDO: usa 'id' genérico
    title: 'Seleccionar Nivel de Instrucción'
  },
  profesion: {
    modalId: 'modalBuscarProfesion',
    tableId: 'tblProfesion',
    endpoint: '/api/v1/profesiones',
    inputId: 'txtProfesion',
    hiddenId: 'id_profesion',
    dataKey: 'id',  // ← CORREGIDO: usa 'id' genérico
    title: 'Seleccionar Profesión'
  }
};

// ==========================================
// FUNCIONES AUXILIARES
// ==========================================

/**
 * Calcula la edad a partir de una fecha de nacimiento
 */
const calcularEdad = (fechaNacimiento) => {
  if (!fechaNacimiento) return null;
  
  const hoy = new Date();
  const nacimiento = new Date(fechaNacimiento);
  
  // Validar que la fecha no sea futura
  if (nacimiento > hoy) {
    return { error: 'La fecha de nacimiento no puede ser futura' };
  }
  
  // Validar que no sea mayor a 120 años
  let edad = hoy.getFullYear() - nacimiento.getFullYear();
  const mes = hoy.getMonth() - nacimiento.getMonth();
  
  if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
    edad--;
  }
  
  if (edad > 120) {
    return { error: 'La fecha de nacimiento no puede ser mayor a 120 años' };
  }
  
  return { edad, esMenor: edad < 18 };
};

/**
 * Genera la historia clínica en formato: Inicial+Inicial+Cedula
 */
const generarHistoriaClinica = (nombre, apellido, cedula) => {
  if (!nombre || !apellido || !cedula) return '';
  
  const inicialNombre = nombre.charAt(0).toUpperCase();
  const inicialApellido = apellido.charAt(0).toUpperCase();
  
  return `${inicialNombre}${inicialApellido}${cedula}`;
};

/**
 * Actualiza el preview de historia clínica en tiempo real
 */
const actualizarPreviewHistoria = () => {
  const nombre = $('#txtNombre').val();
  const apellido = $('#txtApellido').val();
  const cedula = $('#txtCedula').val();
  
  const historia = generarHistoriaClinica(nombre, apellido, cedula);
  
  if (historia) {
    $('#previewHistoria').text(historia).addClass('text-success').removeClass('text-muted');
  } else {
    $('#previewHistoria').text('--').addClass('text-muted').removeClass('text-success');
  }
};

/**
 * Muestra alerta visual de edad calculada
 */
const mostrarAlertaEdad = (resultado) => {
  const alertaDiv = $('#alertaEdad');
  
  if (resultado.error) {
    alertaDiv.html(`
      <div class="alerta-error">
        <i class="fas fa-exclamation-circle"></i> ${resultado.error}
      </div>
    `).show();
    return;
  }
  
  if (resultado.esMenor) {
    alertaDiv.html(`
      <div class="alerta-menor">
        <i class="fas fa-child"></i> <strong>Menor de edad (${resultado.edad} años)</strong><br>
        <small>Se habilitará el paso de datos del tutor</small>
      </div>
    `).show();
  } else {
    alertaDiv.html(`
      <div class="alerta-mayor">
        <i class="fas fa-user-check"></i> <strong>Mayor de edad (${resultado.edad} años)</strong>
      </div>
    `).show();
  }
};

/**
 * Ajusta el wizard según si es menor o no
 */
const ajustarWizardSegunEdad = (esMenor) => {
  if (esMenor) {
    // Mostrar paso 4 (tutor)
    $('.stepwizard-step').eq(3).show(); // Paso 4 visible
    
    // Si estamos en paso 3, mostrar botón siguiente
    if (currentStep === 3) {
      $('#btnSiguiente').show();
      $('#btnGuardar').hide();
    }
  } else {
    // Ocultar paso 4 (tutor)
    $('.stepwizard-step').eq(3).hide();
    limpiarDatosMenor();
    
    // Si estamos en paso 3, es el último paso
    if (currentStep === 3) {
      $('#btnSiguiente').hide();
      $('#btnGuardar').show();
    }
  }
};

/**
 * Limpia los datos del menor
 */
const limpiarDatosMenor = () => {
  $('#txtNomMadre').val('');
  $('#txtTelMadre').val('');
  $('#txtNomPadre').val('');
  $('#txtTelPadre').val('');
  $('#txtEducacion').val('');
  $('#txtColegio').val('');
  $('#txtTelColegio').val('');
};

/**
 * Función para sanitizar texto opcional
 */
const sanitizeText = (value) => {
  if (value === undefined || value === null || value === '' || value === 'undefined' || value === 'null') {
    return null;
  }
  return value;
};

/**
 * Función para sanitizar IDs
 */
const sanitizeId = (value) => {
  // Log para debugging
  console.log(`🔍 sanitizeId input: "${value}" (tipo: ${typeof value})`);
  
  if (value === '' || value === 'undefined' || value === 'null' || value === undefined || value === null) {
    console.log(`   ➡️ Retornando null (valor vacío)`);
    return null;
  }
  const num = Number(value);
  
  if (isNaN(num)) {
    console.log(`   ➡️ Retornando null (NaN)`);
    return null;
  }
  
  console.log(`   ➡️ Retornando ${num}`);
  return num;
};

// ==========================================
// EVENTOS DE CÁLCULO AUTOMÁTICO
// ==========================================

/**
 * Listener para calcular edad automáticamente
 */
const initCalculoEdad = () => {
  $('#txtFecha_nacimiento').on('change', function() {
    const fecha = $(this).val();
    
    if (!fecha) {
      $('#alertaEdad').hide();
      ajustarWizardSegunEdad(false);
      return;
    }
    
    const resultado = calcularEdad(fecha);
    mostrarAlertaEdad(resultado);
    
    if (!resultado.error) {
      ajustarWizardSegunEdad(resultado.esMenor);
    } else {
      ajustarWizardSegunEdad(false);
    }
  });
};

/**
 * Listeners para actualizar preview de historia clínica
 */
const initPreviewHistoria = () => {
  $('#txtNombre, #txtApellido, #txtCedula').on('input', function() {
    actualizarPreviewHistoria();
  });
};

// ==========================================
// DATATABLE PRINCIPAL
// ==========================================
const initDatatable = () => {
  $('#tbl').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/pacientes',
      dataSrc: function(json) {
        if (!json.success) {
          console.error('Error del servidor:', json.error);
          return [];
        }
        return json.data;
      },
      error: function(xhr, error, thrown) {
        console.error('Error en AJAX:', xhr.responseText);
        Swal.fire('Error', 'Error al cargar los pacientes.', 'error');
      }
    },
    columns: [
      { data: 'historia_clinica' },
      { data: 'nombre' },
      { data: 'apellido' },
      { data: 'cedula' },
      { data: 'edad', className: 'text-center' },
      { data: 'telefono' },
      { data: 'genero' },
      { data: 'ciudad' },
      { data: 'fecha_registro' },
      { 
        data: function(row) {
          return `
            <button type="button" name="btn_ver" class="btn btn-info btn-sm" 
                    data-id="${row.id_paciente}" title="Ver Ficha">
              <i class="fas fa-eye"></i>
            </button>
            <button type="button" name="btn_editar" class="btn btn-warning btn-sm" 
                    data-id="${row.id_paciente}" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" name="btn_eliminar" class="btn btn-secondary btn-sm" 
                    data-id="${row.id_paciente}" data-nombre="${row.nombre} ${row.apellido}" title="Eliminar">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;
        },
        className: 'text-center',
        orderable: false
      }
    ],
    order: [[8, 'desc']]
  });
};

// ==========================================
// SISTEMA DE BÚSQUEDA UNIFICADO
// ==========================================
const initSearchDatatable = (configKey) => {
  const config = SEARCH_CONFIGS[configKey];
  
  const table = $(`#${config.tableId}`).DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: config.endpoint,
    columns: [
      { data: 'descripcion' },
      { 
        data: function(row) {
          return `<button type="button" class="btn btn-success btn-sm btn-select-item" 
                    data-id="${row[config.dataKey]}" 
                    data-descripcion="${row.descripcion}">
                    <i class="fa fa-check"></i> Seleccionar
                  </button>`;
        }
      }
    ]
  });
  
  // Evento de selección usando delegación
  $(`#${config.tableId} tbody`).on('click', '.btn-select-item', function() {
    const id = $(this).data('id');
    const descripcion = $(this).data('descripcion');
    
    console.log(`✅ Seleccionado ${configKey}: ID=${id}, Descripción=${descripcion}`);
    
    $(`#${config.inputId}`).val(descripcion);
    $(`#${config.hiddenId}`).val(id);
    $(`#${config.modalId}`).modal('hide');
  });
};

const bindSearchClick = (configKey) => {
  const config = SEARCH_CONFIGS[configKey];
  
  // Agregar cursor pointer y ícono de búsqueda
  $(`#${config.inputId}`).css('cursor', 'pointer').on('click', function() {
    $(`#${config.modalId}`).modal('show');
  });
  
  // Agregar tooltip informativo
  $(`#${config.inputId}`).attr('title', 'Clic para buscar').tooltip();
};

// ==========================================
// WIZARD - NAVEGACIÓN POR PASOS
// ==========================================
const initWizard = () => {
  $('#btnSiguiente').click(function() {
    if (validateCurrentStep()) {
      nextStep();
    }
  });

  $('#btnAnterior').click(function() {
    previousStep();
  });
};

const showStep = (step) => {
  $('.wizard-step').hide();
  $(`.wizard-step[data-step="${step}"]`).fadeIn();
  
  // Actualizar indicadores
  $('.stepwizard-step button').removeClass('btn-primary btn-success').addClass('btn-default');
  $(`.stepwizard-step button[data-step="${step}"]`).removeClass('btn-default').addClass('btn-primary');
  
  // Marcar anteriores como completados
  for (let i = 1; i < step; i++) {
    $(`.stepwizard-step button[data-step="${i}"]`).removeClass('btn-default btn-primary').addClass('btn-success');
  }
  
  // Controlar botones
  $('#btnAnterior').toggle(step > 1);
  
  // Determinar último paso según si es menor
  const fechaNac = $('#txtFecha_nacimiento').val();
  const resultado = calcularEdad(fechaNac);
  const esMenor = resultado && !resultado.error && resultado.esMenor;
  
  // Si es menor: paso 1,2,3,4(tutor),5(clínico) = último es 5
  // Si es mayor: paso 1,2,3,5(clínico) = último es 5 también
  // PERO paso 3 se comporta como último si NO es menor
  
  if (step === 5) {
    // Paso 5 (clínico) siempre es el último para ambos casos
    $('#btnSiguiente').hide();
    $('#btnGuardar').show();
  } else if (step === 3 && !esMenor) {
    // Paso 3 es el penúltimo para mayores, siguiente lleva a paso 5
    $('#btnSiguiente').show();
    $('#btnGuardar').hide();
  } else {
    $('#btnSiguiente').show();
    $('#btnGuardar').hide();
  }
};

const nextStep = () => {
  // Calcular dinámicamente si es menor
  const fechaNac = $('#txtFecha_nacimiento').val();
  const resultado = calcularEdad(fechaNac);
  const esMenor = resultado && !resultado.error && resultado.esMenor;
  
  // Navegación especial para saltar el paso 4 si NO es menor
  if (currentStep === 1) {
    currentStep = 2;
  } else if (currentStep === 2) {
    currentStep = 3;
  } else if (currentStep === 3) {
    // Si es menor, ir a paso 4 (tutor)
    // Si NO es menor, saltar directo a paso 5 (clínico)
    currentStep = esMenor ? 4 : 5;
  } else if (currentStep === 4) {
    // Solo se llega aquí si es menor
    currentStep = 5;
  }
  
  showStep(currentStep);
};

const previousStep = () => {
  // Si estamos en paso 5 y NO es menor, volver a paso 3
  const fechaNac = $('#txtFecha_nacimiento').val();
  const resultado = calcularEdad(fechaNac);
  const esMenor = resultado && !resultado.error && resultado.esMenor;
  
  if (currentStep === 5 && !esMenor) {
    currentStep = 3;
  } else if (currentStep > 1) {
    currentStep--;
  }
  
  showStep(currentStep);
};

const validateCurrentStep = () => {
  let valid = true;
  
  // Validar campos required del paso actual
  $(`.wizard-step[data-step="${currentStep}"] input[required]`).each(function() {
    if (!$(this).val()) {
      $(this).addClass('is-invalid');
      valid = false;
    } else {
      $(this).removeClass('is-invalid');
    }
  });
  
  // Validación especial para paso 1
  if (currentStep === 1) {
    const fechaNac = $('#txtFecha_nacimiento').val();
    
    if (!fechaNac) {
      $('#txtFecha_nacimiento').addClass('is-invalid');
      valid = false;
    } else {
      const resultado = calcularEdad(fechaNac);
      if (resultado.error) {
        $('#txtFecha_nacimiento').addClass('is-invalid');
        Swal.fire('Error', resultado.error, 'error');
        return false;
      }
    }
  }
  
  // Validación especial para paso 4 (tutor) - CRÍTICO
  if (currentStep === 4) {
    const nomMadre = $('#txtNomMadre').val();
    const nomPadre = $('#txtNomPadre').val();
    
    if (!nomMadre && !nomPadre) {
      $('#txtNomMadre').addClass('is-invalid');
      $('#txtNomPadre').addClass('is-invalid');
      Swal.fire('Error', 'Debe proporcionar al menos el nombre de la madre o del padre', 'error');
      return false;
    } else {
      $('#txtNomMadre').removeClass('is-invalid');
      $('#txtNomPadre').removeClass('is-invalid');
    }
  }
  
  if (!valid) {
    Swal.fire('Atención', 'Complete los campos obligatorios', 'warning');
  }
  
  return valid;
};

// ==========================================
// MODAL VER FICHA COMPLETA
// ==========================================
const verFichaPaciente = () => {
  $('#tbl').on('click', 'button[name="btn_ver"]', function() {
    const idPaciente = $(this).data('id');
    
    // USAR ENDPOINT CORRECTO PARA VISUALIZACIÓN (no /editar)
    fetch(`/api/v1/pacientes/${idPaciente}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      }
    })
    .then(resp => {
      if (!resp.ok) {
        return resp.json().then(data => {
          throw new Error(data.error || 'Error del servidor');
        });
      }
      return resp.json();
    })
    .then(data => {
      if (!data.success) {
        throw new Error(data.error);
      }
      
      const p = data.data;
      
      // Construir HTML de vista
      let html = `
        <div class="mb-3 text-right">
          <button class="btn btn-danger btn-sm" onclick="descargarPDF(${idPaciente})">
            <i class="fas fa-file-pdf"></i> Descargar PDF
          </button>
          <button class="btn btn-success btn-sm" onclick="descargarExcel(${idPaciente})">
            <i class="fas fa-file-excel"></i> Descargar Excel
          </button>
        </div>
        <hr>
        
        <h5 class="mb-3"><i class="fas fa-user"></i> Datos Personales</h5>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Nombre Completo:</strong> ${p.nombre || ''} ${p.apellido || ''}</p>
            <p><strong>Cédula:</strong> ${p.cedula || 'N/A'}</p>
            <p><strong>Fecha de Nacimiento:</strong> ${p.fecha_nacimiento || 'N/A'}</p>
            <p><strong>Edad:</strong> ${p.edad || 'N/A'} años</p>
          </div>
          <div class="col-md-6">
            <p><strong>Sexo:</strong> ${p.genero || 'N/A'}</p>
            <p><strong>Estado Civil:</strong> ${p.estado_civil || 'N/A'}</p>
            <p><strong>Teléfono:</strong> ${p.telefono || 'N/A'}</p>
            <p><strong>Correo:</strong> ${p.correo || 'N/A'}</p>
          </div>
        </div>
        
        <hr>
        <h5 class="mb-3"><i class="fas fa-map-marker-alt"></i> Ubicación</h5>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Domicilio:</strong> ${p.domicilio || 'N/A'}</p>
            <p><strong>Ciudad de Residencia:</strong> ${p.ciudad || 'N/A'}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Ciudad de Nacimiento:</strong> ${p.ciudad_nacimiento || 'N/A'}</p>
          </div>
        </div>
        
        <hr>
        <h5 class="mb-3"><i class="fas fa-graduation-cap"></i> Formación</h5>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Nivel de Instrucción:</strong> ${p.nivel_instruccion || 'N/A'}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Profesión:</strong> ${p.profesion || 'N/A'}</p>
          </div>
        </div>
        
        <hr>
        <h5 class="mb-3"><i class="fas fa-notes-medical"></i> Datos Clínicos</h5>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Historia Clínica:</strong> ${p.historia_clinica || 'N/A'}</p>
            <p><strong>Fecha de Registro:</strong> ${p.fecha_registro || 'N/A'}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Es Menor:</strong> ${p.es_menor ? 'Sí' : 'No'}</p>
          </div>
        </div>
        ${p.observaciones ? `<p><strong>Observaciones:</strong> ${p.observaciones}</p>` : ''}
      `;
      
      // Si es menor, agregar datos de tutores
      if (p.es_menor) {
        html += `
          <hr>
          <h5 class="mb-3"><i class="fas fa-users"></i> Datos de Tutores</h5>
          <div class="row">
            <div class="col-md-6">
              <h6>Madre</h6>
              <p><strong>Nombre:</strong> ${p.nom_madre || 'N/A'}</p>
              <p><strong>Teléfono:</strong> ${p.tel_madre || 'N/A'}</p>
            </div>
            <div class="col-md-6">
              <h6>Padre</h6>
              <p><strong>Nombre:</strong> ${p.nom_padre || 'N/A'}</p>
              <p><strong>Teléfono:</strong> ${p.tel_padre || 'N/A'}</p>
            </div>
          </div>
          <hr>
          <h5 class="mb-3"><i class="fas fa-school"></i> Datos Escolares</h5>
          <div class="row">
            <div class="col-md-4">
              <p><strong>Educación:</strong> ${p.educacion || 'N/A'}</p>
            </div>
            <div class="col-md-4">
              <p><strong>Colegio:</strong> ${p.colegio || 'N/A'}</p>
            </div>
            <div class="col-md-4">
              <p><strong>Tel. Colegio:</strong> ${p.tel_colegio || 'N/A'}</p>
            </div>
          </div>
        `;
      }
      
      $('#contenidoVistaPaciente').html(html);
      $('#modalVistaPaciente').modal('show');
    })
    .catch(err => {
      console.error(err);
      Swal.fire("Error", err.message || "No se pudo cargar los datos del paciente.", "error");
    });
  });
};

// Funciones de descarga (globales para usar desde onclick)
window.descargarPDF = (id) => {
  window.open(`/api/v1/pacientes/${id}/pdf`, '_blank');
};

window.descargarExcel = (id) => {
  window.open(`/api/v1/pacientes/${id}/excel`, '_blank');
};

// ==========================================
// CRUD - FUNCIONES PRINCIPALES
// ==========================================
const agregar = () => {
  $('#btnAgregar').on('click', function() {
    $('#modalTitle').text("Agregar Nuevo Paciente");
    limpiarFormulario();
    currentStep = 1;
    showStep(1);
    $('#modalFormulario').modal();
  });
};

const limpiarFormulario = () => {
  $('#formPaciente')[0].reset();
  
  $('#txtIdPersona').val("");
  $('#txtIdPaciente').val("");
  
  // Limpiar IDs ocultos
  $('#id_genero').val("");
  $('#id_estado_civil').val("");
  $('#id_ciudad').val("");
  $('#id_ciudad_nacimiento').val("");
  $('#id_nivel_instruccion').val("");
  $('#id_profesion').val("");
  
  // Ocultar alerta de edad
  $('#alertaEdad').hide();
  
  // Ocultar paso 4 (tutor) por defecto
  $('.stepwizard-step').eq(3).hide();
  limpiarDatosMenor();
  
  // Limpiar preview
  $('#previewHistoria').text('--').addClass('text-muted').removeClass('text-success');
  
  // Limpiar validaciones
  $('.form-control').removeClass('is-invalid');
  
  // Resetear wizard
  currentStep = 1;
};

const guardar = () => {
  $('#btnGuardar').on('click', function() {
    const idPaciente = $('#txtIdPaciente').val();
    
    // Validar fecha obligatoria
    const fechaNacimiento = $('#txtFecha_nacimiento').val();
    if (!fechaNacimiento) {
      Swal.fire('Error', 'La fecha de nacimiento es obligatoria', 'error');
      return;
    }
    
    // Validar fecha
    const resultadoEdad = calcularEdad(fechaNacimiento);
    if (resultadoEdad.error) {
      Swal.fire('Error', resultadoEdad.error, 'error');
      return;
    }
    
    // Datos básicos obligatorios
    const nombre = $('#txtNombre').val();
    const apellido = $('#txtApellido').val();
    const cedula = $('#txtCedula').val();
    const telefono = $('#txtTelefono').val();
    
    if (!nombre || !apellido || !cedula || !telefono) {
      Swal.fire("Error", "Complete los campos obligatorios (Nombre, Apellido, Cédula, Teléfono)", "error");
      return;
    }
    
    // VALIDACIÓN CRÍTICA: Si es menor, validar tutores
    if (resultadoEdad.esMenor) {
      const nomMadre = sanitizeText($('#txtNomMadre').val());
      const nomPadre = sanitizeText($('#txtNomPadre').val());
      
      if (!nomMadre && !nomPadre) {
        Swal.fire('Error', 'El paciente es menor de edad. Debe proporcionar al menos el nombre de la madre o del padre.', 'error');
        return;
      }
    }
    
    // Datos opcionales
    const correo = sanitizeText($('#txtCorreo').val());
    const domicilio = sanitizeText($('#txtDomicilio').val());
    
    // IDs de tablas referenciales
    const id_genero = sanitizeId($('#id_genero').val());
    const id_estado_civil = sanitizeId($('#id_estado_civil').val());
    const id_ciudad = sanitizeId($('#id_ciudad').val());
    const id_ciudad_nacimiento = sanitizeId($('#id_ciudad_nacimiento').val());
    const id_nivel_instruccion = sanitizeId($('#id_nivel_instruccion').val());
    const id_profesion = sanitizeId($('#id_profesion').val());
    
    console.log('📊 IDs capturados:');
    console.log('  - id_genero:', id_genero);
    console.log('  - id_estado_civil:', id_estado_civil);
    console.log('  - id_ciudad:', id_ciudad);
    console.log('  - id_ciudad_nacimiento:', id_ciudad_nacimiento);
    console.log('  - id_nivel_instruccion:', id_nivel_instruccion);
    console.log('  - id_profesion:', id_profesion);
    
    // Datos de paciente
    // IMPORTANTE: NO enviar historia_clinica en POST, dejar que el DAO la genere
    // En PUT sí la enviamos porque ya existe
    const historia_clinica = idPaciente ? sanitizeText($('#txtHistoria_clinica').val()) : null;
    const observaciones = sanitizeText($('#txtObservaciones').val());
    
    // Datos de menor (solo si es menor)
    const nom_madre = resultadoEdad.esMenor ? sanitizeText($('#txtNomMadre').val()) : null;
    const tel_madre = resultadoEdad.esMenor ? sanitizeText($('#txtTelMadre').val()) : null;
    const nom_padre = resultadoEdad.esMenor ? sanitizeText($('#txtNomPadre').val()) : null;
    const tel_padre = resultadoEdad.esMenor ? sanitizeText($('#txtTelPadre').val()) : null;
    const educacion = resultadoEdad.esMenor ? sanitizeText($('#txtEducacion').val()) : null;
    const colegio = resultadoEdad.esMenor ? sanitizeText($('#txtColegio').val()) : null;
    const tel_colegio = resultadoEdad.esMenor ? sanitizeText($('#txtTelColegio').val()) : null;
    
    const dataPaciente = {
      nombre,
      apellido,
      cedula,
      fecha_nacimiento: fechaNacimiento,
      telefono,
      correo,
      domicilio,
      id_genero,
      id_estado_civil,
      id_ciudad,
      id_ciudad_nacimiento,
      id_nivel_instruccion,
      id_profesion,
      observaciones,
      nom_madre,
      tel_madre,
      nom_padre,
      tel_padre,
      educacion,
      colegio,
      tel_colegio
    };
    
    // Solo agregar historia_clinica en PUT (actualización)
    if (idPaciente && historia_clinica) {
      dataPaciente.historia_clinica = historia_clinica;
    }
    
    // IMPORTANTE: NO enviar es_menor - el backend lo calcula automáticamente
    
    const tabla = $('#tbl').DataTable();
    const url = idPaciente ? `/api/v1/pacientes/${idPaciente}` : '/api/v1/pacientes';
    const method = idPaciente ? 'PUT' : 'POST';
    
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify(dataPaciente)
    })
    .then(resp => {
      if (!resp.ok) {
        return resp.json().then(data => {
          throw new Error(data.error || 'Error del servidor');
        });
      }
      return resp.json();
    })
    .then(data => {
      if (data && data.success) {
        tabla.ajax.reload();
        $('#modalFormulario').modal("hide");
        Swal.fire("Éxito", `El paciente ha sido ${idPaciente ? 'actualizado' : 'agregado'} correctamente.`, "success");
      } else {
        Swal.fire("Error", data.error || "Ocurrió un error", "error");
      }
    })
    .catch(err => {
      console.error(err);
      Swal.fire("Error", err.message || "Ocurrió un error al guardar el paciente.", "error");
    });
  });
};

const editar = () => {
  $('#tbl').on('click', 'button[name="btn_editar"]', function() {
    Swal.fire({
      title: "¿Deseas editar este paciente?",
      showCancelButton: true,
      confirmButtonText: "Sí",
      cancelButtonText: "No"
    }).then((result) => {
      if (result.isConfirmed) {
        $('#modalTitle').text("Editar Paciente");
        
        const idPaciente = $(this).data('id');
        $('#txtIdPaciente').val(idPaciente);
        
        // Usar endpoint /editar para obtener IDs originales
        fetch(`/api/v1/pacientes/${idPaciente}/editar`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRFToken
          }
        })
        .then(resp => {
          if (!resp.ok) {
            return resp.json().then(data => {
              throw new Error(data.error || 'Error del servidor');
            });
          }
          return resp.json();
        })
        .then(data => {
          if (!data.success) {
            throw new Error(data.error);
          }
          
          const p = data.data;
          
          // Datos básicos
          $('#txtIdPersona').val(p.id_persona || '');
          $('#txtNombre').val(p.nombre || '');
          $('#txtApellido').val(p.apellido || '');
          $('#txtCedula').val(p.cedula || '');
          $('#txtFecha_nacimiento').val(p.fecha_nacimiento || '');
          $('#txtTelefono').val(p.telefono || '');
          $('#txtCorreo').val(p.correo || '');
          $('#txtDomicilio').val(p.domicilio || '');
          
          // IDs ocultos y textos visibles
          $('#id_genero').val(p.id_genero || '');
          $('#txtGenero').val(p.genero || '');
          
          $('#id_estado_civil').val(p.id_estado_civil || '');
          $('#txtEstado_civil').val(p.estado_civil || '');
          
          $('#id_ciudad').val(p.id_ciudad || '');
          $('#txtCiudad').val(p.ciudad || '');
          
          $('#id_ciudad_nacimiento').val(p.id_ciudad_nacimiento || '');
          $('#txtCiudad_nacimiento').val(p.ciudad_nacimiento || '');
          
          $('#id_nivel_instruccion').val(p.id_nivel_instruccion || '');
          $('#txtNivel_instruccion').val(p.nivel_instruccion || '');
          
          $('#id_profesion').val(p.id_profesion || '');
          $('#txtProfesion').val(p.profesion || '');
          
          // Datos del paciente
          $('#txtHistoria_clinica').val(p.historia_clinica || '');
          $('#txtObservaciones').val(p.observaciones || '');
          
          // RECALCULAR edad automáticamente desde la fecha
          if (p.fecha_nacimiento) {
            const resultado = calcularEdad(p.fecha_nacimiento);
            mostrarAlertaEdad(resultado);
            
            if (!resultado.error && resultado.esMenor) {
              // Mostrar paso 4 y cargar datos de tutor
              $('.stepwizard-step').eq(3).show();
              
              $('#txtNomMadre').val(p.nom_madre || '');
              $('#txtTelMadre').val(p.tel_madre || '');
              $('#txtNomPadre').val(p.nom_padre || '');
              $('#txtTelPadre').val(p.tel_padre || '');
              $('#txtEducacion').val(p.educacion || '');
              $('#txtColegio').val(p.colegio || '');
              $('#txtTelColegio').val(p.tel_colegio || '');
            } else {
              // Ocultar paso 4 si ya no es menor
              $('.stepwizard-step').eq(3).hide();
            }
          }
          
          // Actualizar preview de historia clínica
          actualizarPreviewHistoria();
          
          // Resetear wizard al paso 1
          currentStep = 1;
          showStep(1);
          
          $('#modalFormulario').modal('show');
        })
        .catch(err => {
          console.error(err);
          Swal.fire("Error", err.message || "No se pudo cargar los datos del paciente.", "error");
        });
      }
    });
  });
};

const eliminar = () => {
  $('#tbl').on('click', 'button[name="btn_eliminar"]', function() {
    const idPaciente = $(this).data('id');
    const nombrePaciente = $(this).data('nombre');
    
    Swal.fire({
      title: "¿Deseas eliminar este paciente?",
      text: `Paciente: ${nombrePaciente}`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Sí, eliminar",
      cancelButtonText: "No",
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(`/api/v1/pacientes/${idPaciente}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRFToken
          }
        })
        .then(resp => {
          if (!resp.ok) {
            return resp.json().then(data => {
              throw new Error(data.error || 'Error del servidor');
            });
          }
          return resp.json();
        })
        .then(data => {
          if (data && data.success) {
            const tabla = $('#tbl').DataTable();
            tabla.ajax.reload();
            Swal.fire("Eliminado", "El paciente ha sido eliminado correctamente.", "success");
          } else {
            Swal.fire("Error", data.error || "No se pudo eliminar el paciente.", "error");
          }
        })
        .catch(err => {
          console.error(err);
          Swal.fire("Error", err.message || "Ocurrió un error al eliminar el paciente.", "error");
        });
      }
    });
  });
};

// ==========================================
// INICIALIZACIÓN
// ==========================================
const addEvents = () => {
  initWizard();
  initCalculoEdad();
  initPreviewHistoria();
  agregar();
  guardar();
  editar();
  eliminar();
  verFichaPaciente();
  
  // Vincular búsquedas unificadas
  Object.keys(SEARCH_CONFIGS).forEach(key => {
    bindSearchClick(key);
  });
  
  // Activar tooltips de Bootstrap
  $('[data-toggle="tooltip"]').tooltip();
};

$(document).ready(function() {
  // Inicializar DataTable principal
  initDatatable();
  
  // Inicializar DataTables de búsqueda (unificado)
  Object.keys(SEARCH_CONFIGS).forEach(key => {
    initSearchDatatable(key);
  });
  
  // Activar todos los eventos
  addEvents();
  
  // Ocultar paso 4 (tutor) por defecto al cargar
  $('.stepwizard-step').eq(3).hide();
});

</script>
{% endblock %}