{% extends 'base.html' %}

{% block titulo %}
Registrar Diagnóstico
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
    <h3><i class="fas fa-diagnoses"></i> Registrar Diagnóstico Médico</h3>
    
    <!-- Tarjeta principal -->
    <div class="card shadow">
        <!-- Header -->
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-clipboard-list"></i> Consultas Disponibles
            </h5>
        </div>

        <!-- Cuerpo con tabla -->
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered w-100" id="tblConsultas">
                    <thead class="thead-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Paciente</th>
                            <th>HC</th>
                            <th>Profesional</th>
                            <th>Motivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registrar Diagnóstico -->
<div class="modal fade" id="modalRegistrarDiagnostico" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h4 class="modal-title">
                    <i class="fas fa-diagnoses"></i> Registrar Diagnóstico
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Información de la Consulta -->
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-info-circle"></i> Información de la Consulta
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Paciente:</strong> <span id="infoPaciente"></span></p>
                                <p class="mb-1"><strong>HC:</strong> <span id="infoHC"></span></p>
                                <p class="mb-1"><strong>Fecha Consulta:</strong> <span id="infoFecha"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Profesional:</strong> <span id="infoProfesional"></span></p>
                                <p class="mb-1"><strong>Motivo:</strong> <span id="infoMotivo"></span></p>
                                <p class="mb-1"><strong>Estado:</strong> <span id="infoEstado"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="formDiagnostico">
                    <input type="hidden" id="id_consulta">

                    <!-- Buscar Diagnóstico CIE-10 -->
                    <div class="form-group">
                        <label>Diagnóstico (CIE-10): <span class="text-danger">*</span></label>
                        <input type="hidden" id="id_diagnostico">
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   placeholder="Haga clic para buscar diagnóstico CIE-10" 
                                   id="txtDiagnostico" 
                                   readonly 
                                   required>
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="btnBuscarDiagnostico">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            Código y descripción del diagnóstico según CIE-10
                        </small>
                    </div>

                    <!-- Tipo de Diagnóstico -->
                    <div class="form-group">
                        <label>Tipo de Diagnóstico: <span class="text-danger">*</span></label>
                        <select class="form-control" id="tipo_diagnostico" required>
                            <option value="">Seleccione...</option>
                            <option value="PRINCIPAL">Principal</option>
                            <option value="SECUNDARIO">Secundario</option>
                            <option value="DIFERENCIAL">Diferencial</option>
                        </select>
                    </div>

                    <!-- Estado del Diagnóstico -->
                    <div class="form-group">
                        <label>Estado del Diagnóstico: <span class="text-danger">*</span></label>
                        <select class="form-control" id="estado_diagnostico" required>
                            <option value="">Seleccione...</option>
                            <option value="CONFIRMADO" selected>Confirmado</option>
                            <option value="PRESUNTIVO">Presuntivo</option>
                            <option value="DESCARTADO">Descartado</option>
                        </select>
                    </div>

                    <!-- Descripción Adicional -->
                    <div class="form-group">
                        <label>Descripción Adicional:</label>
                        <textarea class="form-control" id="descripcion_adicional" rows="3" 
                                  placeholder="Información adicional sobre el diagnóstico..."></textarea>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-group">
                        <label>Observaciones:</label>
                        <textarea class="form-control" id="observaciones" rows="2" 
                                  placeholder="Observaciones generales..."></textarea>
                    </div>
                </form>

                <!-- Lista de diagnósticos ya registrados -->
                <div id="listaDiagnosticos" style="display: none;">
                    <hr>
                    <h6 class="text-primary">
                        <i class="fas fa-list"></i> Diagnósticos Registrados en esta Consulta
                    </h6>
                    <div id="contenidoDiagnosticos"></div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-info" id="btnGuardarDiagnostico">
                    <i class="fas fa-save"></i> Guardar Diagnóstico
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Buscar Diagnóstico CIE-10 -->
<div class="modal fade" id="modalBuscarDiagnostico" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-search"></i> Buscar Diagnóstico CIE-10
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered w-100" id="tblDiagnosticos">
                        <thead class="thead-dark">
                            <tr>
                                <th>Código CIE-10</th>
                                <th>Descripción</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#tblConsultas tbody tr {
    cursor: pointer;
}

#tblConsultas tbody tr:hover {
    background-color: #e7f3ff;
}

.diagnostico-item {
    padding: 10px;
    border-left: 3px solid #17a2b8;
    margin-bottom: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.diagnostico-item.PRINCIPAL {
    border-left-color: #dc3545;
}

.diagnostico-item.SECUNDARIO {
    border-left-color: #ffc107;
}

.diagnostico-item.DIFERENCIAL {
    border-left-color: #6c757d;
}
</style>

{% endblock %}

{% block js %}
<script>
// ==========================================
// CONFIGURACIÓN GLOBAL
// ==========================================
const CSRFToken = "{{ csrf_token() }}" || null;

// ==========================================
// DATATABLE DE CONSULTAS
// ==========================================
const initDatatable = () => {
  $('#tblConsultas').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/consultas',
      dataSrc: function(json) {
        if (json.success) {
          return json.data;
        } else {
          Swal.fire('Error', json.error || 'Error al cargar consultas', 'error');
          return [];
        }
      },
      error: function(xhr, error, thrown) {
        console.error('Error en AJAX:', xhr.responseText);
        Swal.fire('Error', 'No se pudieron cargar las consultas', 'error');
      }
    },
    columns: [
      { 
        data: 'consulta_fecha',
        render: function(data) {
          return data ? data.split(' ')[0] : 'N/A';
        }
      },
      { 
        data: 'consulta_fecha',
        render: function(data) {
          return data ? data.split(' ')[1] : 'N/A';
        }
      },
      { data: 'paciente_nombre' },
      { data: 'historia_clinica' },
      { data: 'profesional_nombre' },
      { 
        data: 'consulta_motivo',
        render: function(data) {
          return data.length > 50 ? data.substring(0, 50) + '...' : data;
        }
      },
      { 
        data: 'consulta_estado',
        render: function(data) {
          const badges = {
            'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
            'EN_ATENCION': '<span class="badge badge-info">En Atención</span>',
            'FINALIZADA': '<span class="badge badge-success">Finalizada</span>'
          };
          return badges[data] || data;
        },
        className: 'text-center'
      },
      { 
        data: function(row) {
          return `
            <button type="button" class="btn btn-info btn-sm btn-registrar-diagnostico" 
                    data-id="${row.id_consulta}" 
                    data-paciente="${row.paciente_nombre}"
                    data-hc="${row.historia_clinica}"
                    data-profesional="${row.profesional_nombre}"
                    data-fecha="${row.consulta_fecha}"
                    data-motivo="${row.consulta_motivo}"
                    data-estado="${row.consulta_estado}"
                    title="Registrar Diagnóstico">
              <i class="fas fa-plus-circle"></i> Agregar Diagnóstico
            </button>
          `;
        },
        className: 'text-center',
        orderable: false
      }
    ],
    order: [[0, 'desc'], [1, 'desc']],
    responsive: true,
    pageLength: 10
  });
}

// ==========================================
// DATATABLE DE DIAGNÓSTICOS CIE-10
// ==========================================
const initDiagnosticosDatatable = () => {
  $('#tblDiagnosticos').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/diagnosticos',
      dataSrc: function(json) {
        console.log('📋 Respuesta API diagnósticos:', json);
        
        if (!json.success || !json.data) {
          console.error('❌ API no devolvió datos válidos');
          Swal.fire('Error', 'No se pudieron cargar los diagnósticos', 'error');
          return [];
        }
        
        console.log(`✅ Total diagnósticos: ${json.data.length}`);
        
        if (json.data.length > 0) {
          console.log('📄 Primer diagnóstico:', json.data[0]);
          console.log('🔑 Claves disponibles:', Object.keys(json.data[0]));
        }
        
        return json.data;
      },
      error: function(xhr, error, thrown) {
        console.error('❌ Error cargando diagnósticos:', xhr.responseText);
        Swal.fire('Error', 'No se pudieron cargar los diagnósticos CIE-10', 'error');
      }
    },
    columns: [
      { 
        data: 'codigo_cie10',
        render: function(data) {
          return data || '<span class="text-muted">Sin código</span>';
        }
      },
      { 
        data: 'descripcion',
        render: function(data) {
          return data || '<span class="text-muted">Sin descripción</span>';
        }
      },
      { 
        data: function(row) {
          const idDiag = row.id;
          
          if (!idDiag && idDiag !== 0) {
            console.error('❌ Diagnóstico sin ID:', row);
            return '<button class="btn btn-danger btn-sm" disabled><i class="fa fa-times"></i> Sin ID</button>';
          }
          
          const descripcionEscapada = (row.descripcion || '')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
          
          const codigoEscapado = (row.codigo_cie10 || '')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
          
          return `
            <button type="button" 
                    class="btn btn-success btn-sm btn-select-diagnostico" 
                    data-id="${idDiag}" 
                    data-codigo="${codigoEscapado}"
                    data-descripcion="${descripcionEscapada}">
              <i class="fa fa-check"></i> Seleccionar
            </button>
          `;
        },
        orderable: false,
        className: 'text-center'
      }
    ],
    responsive: true,
    pageLength: 8
  });
}

// ==========================================
// ABRIR MODAL Y PRE-CARGAR DATOS
// ==========================================
const registrarDiagnostico = () => {
  $('#tblConsultas').on('click', '.btn-registrar-diagnostico', function() {
    const data = $(this).data();
    
    $('#infoPaciente').text(data.paciente);
    $('#infoHC').text(data.hc);
    $('#infoFecha').text(data.fecha);
    $('#infoProfesional').text(data.profesional);
    $('#infoMotivo').text(data.motivo);
    $('#infoEstado').html($(this).closest('tr').find('td:eq(6)').html());
    
    $('#id_consulta').val(data.id);
    
    $('#id_diagnostico').val('');
    $('#txtDiagnostico').val('').removeClass('is-invalid is-valid');
    $('#tipo_diagnostico').val('');
    $('#estado_diagnostico').val('CONFIRMADO');
    $('#descripcion_adicional').val('');
    $('#observaciones').val('');
    
    cargarDiagnosticosExistentes(data.id);
    
    $('#modalRegistrarDiagnostico').modal('show');
  });
}

// ==========================================
// CARGAR DIAGNÓSTICOS EXISTENTES
// ==========================================
const cargarDiagnosticosExistentes = (idConsulta) => {
  fetch(`/api/v1/diagnosticos/consulta/${idConsulta}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRFToken
    }
  })
  .then(resp => {
    if (!resp.ok) {
      if (resp.status === 404) {
        console.log('ℹ️ No hay diagnósticos previos para esta consulta');
        $('#listaDiagnosticos').hide();
        return null;
      }
      throw new Error(`HTTP ${resp.status}`);
    }
    return resp.json();
  })
  .then(data => {
    if (!data) return;
    
    if (data.success && data.data && data.data.length > 0) {
      console.log('📋 Diagnósticos existentes:', data.data.length);
      
      let html = '';
      data.data.forEach((diag, index) => {
        html += `
          <div class="diagnostico-item ${diag.tipo}" style="animation: fadeIn 0.3s ease ${index * 0.1}s both;">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong class="text-primary">${diag.codigo_cie10}</strong> - ${diag.descripcion}
                <br>
                <small class="text-muted">
                  <span class="badge badge-secondary">${diag.tipo}</span>
                  <span class="badge badge-info">${diag.estado}</span>
                  ${diag.descripcion_adicional ? `<span class="badge badge-light"><i class="fas fa-info-circle"></i> Con descripción adicional</span>` : ''}
                </small>
              </div>
            </div>
          </div>
        `;
      });
      
      $('#contenidoDiagnosticos').html(html);
      $('#listaDiagnosticos').show();
    } else {
      $('#listaDiagnosticos').hide();
    }
  })
  .catch(err => {
    console.error('⚠️ Error cargando diagnósticos existentes:', err);
    $('#listaDiagnosticos').hide();
  });
}

// ==========================================
// BUSCAR Y SELECCIONAR DIAGNÓSTICO
// ==========================================
const buscarDiagnostico = () => {
  $('#btnBuscarDiagnostico').on('click', function() {
    $('#modalBuscarDiagnostico').modal('show');
  });
  
  $(document).on('click', '.btn-select-diagnostico', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    console.log('🖱️ Click en seleccionar detectado');
    
    const idDiagnostico = $(this).attr('data-id');
    const codigo = $(this).attr('data-codigo');
    const descripcion = $(this).attr('data-descripcion');
    
    console.log('📋 Datos capturados:', {
      id_raw: idDiagnostico,
      id_parsed: parseInt(idDiagnostico),
      codigo: codigo,
      descripcion: descripcion
    });
    
    if (!idDiagnostico || idDiagnostico === 'undefined') {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'ID de diagnóstico no válido. Por favor, recargue la página.'
      });
      console.error('❌ ID diagnóstico inválido:', idDiagnostico);
      return;
    }
    
    const idParsed = parseInt(idDiagnostico);
    if (isNaN(idParsed)) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'El ID del diagnóstico no es un número válido'
      });
      console.error('❌ ID no es número:', idDiagnostico);
      return;
    }
    
    console.log('✅ Diagnóstico seleccionado correctamente:', {
      id: idParsed,
      codigo: codigo,
      descripcion: descripcion
    });
    
    $('#id_diagnostico').val(idParsed);
    $('#txtDiagnostico').val(`${codigo} - ${descripcion}`);
    
    console.log('✅ Valores asignados:', {
      id_diagnostico_field: $('#id_diagnostico').val(),
      txt_diagnostico_field: $('#txtDiagnostico').val()
    });
    
    $('#modalBuscarDiagnostico').modal('hide');
    
    $('#txtDiagnostico').addClass('is-valid').removeClass('is-invalid');
    setTimeout(() => {
      $('#txtDiagnostico').removeClass('is-valid');
    }, 2000);
    
    Swal.fire({
      icon: 'success',
      title: 'Diagnóstico Seleccionado',
      text: `${codigo} - ${descripcion}`,
      timer: 2000,
      showConfirmButton: false,
      toast: true,
      position: 'top-end'
    });
  });
}

// ==========================================
// GUARDAR DIAGNÓSTICO - ✅ CON REGISTRO_FECHA
// ==========================================
const guardarDiagnostico = () => {
  $('#btnGuardarDiagnostico').on('click', function() {
    const idConsulta = parseInt($('#id_consulta').val());
    const idDiagnostico = parseInt($('#id_diagnostico').val());
    const tipoDiagnostico = $('#tipo_diagnostico').val();
    const estadoDiagnostico = $('#estado_diagnostico').val();
    
    console.log('🔍 Validando datos:', {
      idConsulta,
      idDiagnostico,
      tipoDiagnostico,
      estadoDiagnostico
    });
    
    // Validación 1: ID de consulta
    if (!idConsulta || isNaN(idConsulta)) {
      Swal.fire('Error', 'ID de consulta no válido', 'error');
      return;
    }
    
    // Validación 2: ID de diagnóstico
    if (!idDiagnostico || isNaN(idDiagnostico)) {
      Swal.fire({
        icon: 'warning',
        title: 'Diagnóstico no seleccionado',
        text: 'Debe buscar y seleccionar un diagnóstico CIE-10',
        confirmButtonText: 'Entendido'
      });
      $('#txtDiagnostico').addClass('is-invalid');
      return;
    }
    
    // Validación 3: Campos requeridos
    if (!tipoDiagnostico || !estadoDiagnostico) {
      Swal.fire('Atención', 'Complete los campos obligatorios', 'warning');
      return;
    }
    
    // ✅ GENERAR FECHA ACTUAL
    const now = new Date();
    
    // Formato SQL estándar: 'YYYY-MM-DD HH:MM:SS'
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const registroFecha = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    
    console.log('📅 Fecha generada:', registroFecha);
    
    // ✅ CONSTRUIR OBJETO CON TODOS LOS CAMPOS
    const dataDiagnostico = {
      id_consulta: idConsulta,
      id_diagnostico: idDiagnostico,
      tipo_diagnostico: tipoDiagnostico,
      estado_diagnostico: estadoDiagnostico,
      descripcion_adicional: $('#descripcion_adicional').val().trim() || null,
      observaciones: $('#observaciones').val().trim() || null,
      usuario_creacion: 'ADMIN',
      registro_fecha: registroFecha  // ✅ CAMPO AGREGADO
    };
    
    console.log('📤 Enviando diagnóstico:', dataDiagnostico);
    
    const btn = $(this);
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
    
    fetch('/api/v1/registro-diagnosticos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify(dataDiagnostico)
    })
    .then(resp => {
      if (!resp.ok) {
        return resp.json().then(err => {
          throw new Error(err.error || `HTTP ${resp.status}`);
        });
      }
      return resp.json();
    })
    .then(data => {
      btn.prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Diagnóstico');
      
      if (data.success) {
        console.log('✅ Diagnóstico guardado:', data);
        
        $('#tblConsultas').DataTable().ajax.reload();
        cargarDiagnosticosExistentes(idConsulta);
        
        $('#id_diagnostico').val('');
        $('#txtDiagnostico').val('').removeClass('is-invalid is-valid');
        $('#tipo_diagnostico').val('');
        $('#estado_diagnostico').val('CONFIRMADO');
        $('#descripcion_adicional').val('');
        $('#observaciones').val('');
        
        Swal.fire({
          icon: 'success',
          title: '¡Diagnóstico Registrado!',
          text: data.data.mensaje || 'Diagnóstico guardado correctamente',
          showCancelButton: true,
          confirmButtonText: '<i class="fas fa-pills"></i> Registrar Tratamiento',
          cancelButtonText: '<i class="fas fa-plus"></i> Agregar Otro Diagnóstico',
          confirmButtonColor: '#28a745',
          cancelButtonColor: '#6c757d'
        }).then((result) => {
          if (result.isConfirmed) {
            $('#modalRegistrarDiagnostico').modal('hide');
            window.location.href = `/tratamiento/tratamiento-index?id_consulta=${idConsulta}`;
          }
        });
      } else {
        Swal.fire('Error', data.error || 'No se pudo guardar el diagnóstico', 'error');
      }
    })
    .catch(err => {
      btn.prop('disabled', false).html('<i class="fas fa-save"></i> Guardar Diagnóstico');
      console.error('❌ Error guardando diagnóstico:', err);
      Swal.fire('Error', err.message || 'Ocurrió un error al guardar el diagnóstico', 'error');
    });
  });
}

// ==========================================
// INICIALIZACIÓN
// ==========================================
$(document).ready(function() {
  console.log('🚀 Inicializando módulo de diagnósticos...');
  
  initDatatable();
  initDiagnosticosDatatable();
  registrarDiagnostico();
  buscarDiagnostico();
  guardarDiagnostico();
  
  const urlParams = new URLSearchParams(window.location.search);
  const idConsulta = urlParams.get('id_consulta');
  if (idConsulta) {
    console.log('🔗 ID de consulta en URL:', idConsulta);
    setTimeout(() => {
      const btn = $(`.btn-registrar-diagnostico[data-id="${idConsulta}"]`);
      if (btn.length) {
        btn.click();
      } else {
        console.warn('⚠️ No se encontró el botón para la consulta:', idConsulta);
      }
    }, 500);
  }
  
  console.log('✅ Módulo de diagnósticos inicializado');
});

// Agregar animación CSS
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);;

  
</script>
{% endblock %}