{% extends 'base.html' %}

{% block titulo %}
Registrar Procedimiento
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
    <h3><i class="fas fa-procedures"></i> Registrar Procedimiento Médico</h3>
    
    <!-- Tarjeta principal -->
    <div class="card shadow">
        <!-- Header -->
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-clipboard-list"></i> Consultas Disponibles
            </h5>
        </div>

        <!-- Cuerpo con tabla -->
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered w-100" id="tblConsultas">
                    <thead class="thead-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Paciente</th>
                            <th>HC</th>
                            <th>Profesional</th>
                            <th>Motivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registrar Procedimiento -->
<div class="modal fade" id="modalRegistrarProcedimiento" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h4 class="modal-title">
                    <i class="fas fa-procedures"></i> Registrar Procedimiento Médico
                </h4>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Información de la Consulta -->
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-info-circle"></i> Información de la Consulta
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Paciente:</strong> <span id="infoPaciente"></span></p>
                                <p class="mb-1"><strong>HC:</strong> <span id="infoHC"></span></p>
                                <p class="mb-1"><strong>Fecha Consulta:</strong> <span id="infoFecha"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Profesional:</strong> <span id="infoProfesional"></span></p>
                                <p class="mb-1"><strong>Motivo:</strong> <span id="infoMotivo"></span></p>
                                <p class="mb-1"><strong>Estado:</strong> <span id="infoEstado"></span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="formProcedimiento">
                    <input type="hidden" id="id_consulta">
                    <input type="hidden" id="id_paciente">

                    <!-- Buscar Tipo de Procedimiento -->
                    <div class="form-group">
                        <label>Tipo de Procedimiento: <span class="text-danger">*</span></label>
                        <input type="hidden" id="id_tipo_procedimiento">
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   placeholder="Haga clic para buscar tipo de procedimiento" 
                                   id="txtTipoProcedimiento" 
                                   readonly 
                                   required>
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="btnBuscarTipoProcedimiento">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Fecha y Hora del Procedimiento -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Fecha del Procedimiento: <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="fecha_procedimiento" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Estado del Procedimiento: <span class="text-danger">*</span></label>
                                <select class="form-control" id="estado_procedimiento" required>
                                    <option value="">Seleccione...</option>
                                    <option value="PROGRAMADO">Programado</option>
                                    <option value="EN_PROCESO">En Proceso</option>
                                    <option value="COMPLETADO" selected>Completado</option>
                                    <option value="CANCELADO">Cancelado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Profesional que realizó el procedimiento -->
                    <div class="form-group">
                        <label>Profesional que realizó: <span class="text-danger">*</span></label>
                        <input type="hidden" id="id_profesional_realizo">
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   placeholder="Haga clic para buscar profesional" 
                                   id="txtProfesionalRealizo" 
                                   readonly 
                                   required>
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="btnBuscarProfesional">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Descripción del Procedimiento -->
                    <div class="form-group">
                        <label>Descripción del Procedimiento: <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="descripcion_procedimiento" rows="4" 
                                  placeholder="Describa detalladamente el procedimiento realizado..." 
                                  required></textarea>
                    </div>

                    <!-- Resultado del Procedimiento -->
                    <div class="form-group">
                        <label>Resultado del Procedimiento:</label>
                        <textarea class="form-control" id="resultado_procedimiento" rows="3" 
                                  placeholder="Resultado obtenido, hallazgos, evolución..."></textarea>
                    </div>

                    <!-- Observaciones/Complicaciones -->
                    <div class="form-group">
                        <label>Observaciones / Complicaciones:</label>
                        <textarea class="form-control" id="observaciones" rows="2" 
                                  placeholder="Complicaciones, observaciones especiales..."></textarea>
                    </div>
                </form>

                <!-- Lista de procedimientos ya registrados -->
                <div id="listaProcedimientos" style="display: none;">
                    <hr>
                    <h6 class="text-success">
                        <i class="fas fa-list"></i> Procedimientos Registrados en esta Consulta
                    </h6>
                    <div id="contenidoProcedimientos"></div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnGuardarProcedimiento">
                    <i class="fas fa-save"></i> Guardar Procedimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Buscar Tipo de Procedimiento -->
<div class="modal fade" id="modalBuscarTipoProcedimiento" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-search"></i> Buscar Tipo de Procedimiento
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered w-100" id="tblTiposProcedimiento">
                        <thead class="thead-dark">
                            <tr>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Buscar Profesional -->
<div class="modal fade" id="modalBuscarProfesional" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-md"></i> Seleccionar Profesional
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered w-100" id="tblProfesionales">
                        <thead class="thead-dark">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Matrícula</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#tblConsultas tbody tr {
    cursor: pointer;
}

#tblConsultas tbody tr:hover {
    background-color: #e7f3ff;
}

.procedimiento-item {
    padding: 10px;
    border-left: 3px solid #28a745;
    margin-bottom: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.procedimiento-item.PROGRAMADO {
    border-left-color: #ffc107;
}

.procedimiento-item.EN_PROCESO {
    border-left-color: #17a2b8;
}

.procedimiento-item.COMPLETADO {
    border-left-color: #28a745;
}

.procedimiento-item.CANCELADO {
    border-left-color: #dc3545;
}
</style>

{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

// ==========================================
// DATATABLE DE CONSULTAS
// ==========================================
const initDatatable = () => {
  $('#tblConsultas').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/consultas',
      dataSrc: function(json) {
        if (json.success) {
          return json.data;
        } else {
          Swal.fire('Error', json.error || 'Error al cargar consultas', 'error');
          return [];
        }
      },
      error: function(xhr, error, thrown) {
        console.error('Error en AJAX:', xhr.responseText);
        Swal.fire('Error', 'No se pudieron cargar las consultas', 'error');
      }
    },
    columns: [
      { 
        data: 'consulta_fecha',
        render: function(data) {
          return data ? data.split(' ')[0] : 'N/A';
        }
      },
      { 
        data: 'consulta_fecha',
        render: function(data) {
          return data ? data.split(' ')[1] : 'N/A';
        }
      },
      { data: 'paciente_nombre' },
      { data: 'historia_clinica' },
      { data: 'profesional_nombre' },
      { 
        data: 'consulta_motivo',
        render: function(data) {
          return data.length > 50 ? data.substring(0, 50) + '...' : data;
        }
      },
      { 
        data: 'consulta_estado',
        render: function(data) {
          const badges = {
            'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
            'EN_ATENCION': '<span class="badge badge-info">En Atención</span>',
            'FINALIZADA': '<span class="badge badge-success">Finalizada</span>'
          };
          return badges[data] || data;
        },
        className: 'text-center'
      },
      { 
        data: function(row) {
          return `
            <button type="button" class="btn btn-success btn-sm btn-registrar-procedimiento" 
                    data-id="${row.id_consulta}" 
                    data-id-paciente="${row.id_paciente}"
                    data-paciente="${row.paciente_nombre}"
                    data-hc="${row.historia_clinica}"
                    data-profesional="${row.profesional_nombre}"
                    data-fecha="${row.consulta_fecha}"
                    data-motivo="${row.consulta_motivo}"
                    data-estado="${row.consulta_estado}"
                    title="Registrar Procedimiento">
              <i class="fas fa-plus-circle"></i> Agregar Procedimiento
            </button>
          `;
        },
        className: 'text-center',
        orderable: false
      }
    ],
    order: [[0, 'desc'], [1, 'desc']],
    responsive: true,
    pageLength: 10
  });
}

// ==========================================
// DATATABLE DE TIPOS DE PROCEDIMIENTO
// ==========================================
const initTiposProcedimientoDatatable = () => {
  $('#tblTiposProcedimiento').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/tipos-procedimiento',
      dataSrc: function(json) {
        return json.success ? json.data : [];
      }
    },
    columns: [
      { data: 'nombre' },
      { data: 'descripcion' },
      { 
        data: function(row) {
          return `
            <button type="button" class="btn btn-success btn-sm btn-select-tipo-procedimiento" 
                    data-id="${row.id_tipo_procedimiento}" 
                    data-nombre="${row.nombre}"
                    data-descripcion="${row.descripcion}">
              <i class="fa fa-check"></i> Seleccionar
            </button>
          `;
        },
        orderable: false,
        className: 'text-center'
      }
    ],
    responsive: true,
    pageLength: 8
  });
}

// ==========================================
// DATATABLE DE PROFESIONALES
// ==========================================
const initProfesionalesDatatable = () => {
  $('#tblProfesionales').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/especialistas',
      dataSrc: function(json) {
        return json.success ? json.data : [];
      }
    },
    columns: [
      { data: 'nombre_completo' },
      { data: 'matricula' },
      { 
        data: function(row) {
          return `
            <button type="button" class="btn btn-success btn-sm btn-select-profesional" 
                    data-id="${row.id_especialista}" 
                    data-nombre="${row.nombre_completo}">
              <i class="fa fa-check"></i> Seleccionar
            </button>
          `;
        },
        orderable: false,
        className: 'text-center'
      }
    ],
    responsive: true,
    pageLength: 8
  });
}

// ==========================================
// ABRIR MODAL Y PRE-CARGAR DATOS
// ==========================================
const registrarProcedimiento = () => {
  $('#tblConsultas').on('click', '.btn-registrar-procedimiento', function() {
    const data = $(this).data();
    
    // Llenar información de la consulta
    $('#infoPaciente').text(data.paciente);
    $('#infoHC').text(data.hc);
    $('#infoFecha').text(data.fecha);
    $('#infoProfesional').text(data.profesional);
    $('#infoMotivo').text(data.motivo);
    $('#infoEstado').html($(this).closest('tr').find('td:eq(6)').html());
    
    // Llenar campos ocultos
    $('#id_consulta').val(data.id);
    $('#id_paciente').val(data.idPaciente);
    
    // Pre-cargar fecha actual
    const ahora = new Date();
    const fechaHoraLocal = ahora.toISOString().slice(0, 16);
    $('#fecha_procedimiento').val(fechaHoraLocal);
    
    // Limpiar formulario
    $('#id_tipo_procedimiento').val('');
    $('#txtTipoProcedimiento').val('');
    $('#id_profesional_realizo').val('');
    $('#txtProfesionalRealizo').val('');
    $('#descripcion_procedimiento').val('');
    $('#resultado_procedimiento').val('');
    $('#observaciones').val('');
    $('#estado_procedimiento').val('COMPLETADO');
    
    // Cargar procedimientos existentes
    cargarProcedimientosExistentes(data.id);
    
    // Abrir modal
    $('#modalRegistrarProcedimiento').modal('show');
  });
}

// ==========================================
// CARGAR PROCEDIMIENTOS EXISTENTES
// ==========================================
const cargarProcedimientosExistentes = (idConsulta) => {
  fetch(`/api/v1/procedimientos/consulta/${idConsulta}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': CSRFToken
    }
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.success && data.data.length > 0) {
      let html = '';
      data.data.forEach(proc => {
        html += `
          <div class="procedimiento-item ${proc.estado}">
            <strong>${proc.tipo_procedimiento}</strong>
            <br>
            <small>
              Fecha: ${proc.fecha} | 
              Profesional: ${proc.profesional} | 
              <span class="badge badge-secondary">${proc.estado}</span>
            </small>
          </div>
        `;
      });
      $('#contenidoProcedimientos').html(html);
      $('#listaProcedimientos').show();
    } else {
      $('#listaProcedimientos').hide();
    }
  })
  .catch(err => {
    console.error('Error cargando procedimientos:', err);
    $('#listaProcedimientos').hide();
  });
}

// ==========================================
// BUSCAR Y SELECCIONAR TIPO DE PROCEDIMIENTO
// ==========================================
const buscarTipoProcedimiento = () => {
  $('#btnBuscarTipoProcedimiento').on('click', function() {
    $('#modalBuscarTipoProcedimiento').modal('show');
  });
  
  $('#tblTiposProcedimiento').on('click', '.btn-select-tipo-procedimiento', function() {
    const data = $(this).data();
    
    $('#id_tipo_procedimiento').val(data.id);
    $('#txtTipoProcedimiento').val(`${data.nombre} - ${data.descripcion}`);
    
    $('#modalBuscarTipoProcedimiento').modal('hide');
  });
}

// ==========================================
// BUSCAR Y SELECCIONAR PROFESIONAL
// ==========================================
const buscarProfesional = () => {
  $('#btnBuscarProfesional').on('click', function() {
    $('#modalBuscarProfesional').modal('show');
  });
  
  $('#tblProfesionales').on('click', '.btn-select-profesional', function() {
    const data = $(this).data();
    
    $('#id_profesional_realizo').val(data.id);
    $('#txtProfesionalRealizo').val(data.nombre);
    
    $('#modalBuscarProfesional').modal('hide');
  });
}

// ==========================================
// GUARDAR PROCEDIMIENTO
// ==========================================
const guardarProcedimiento = () => {
  $('#btnGuardarProcedimiento').on('click', function() {
    // Validar campos obligatorios
    if (!$('#id_tipo_procedimiento').val() || !$('#fecha_procedimiento').val() || 
        !$('#id_profesional_realizo').val() || !$('#descripcion_procedimiento').val() || 
        !$('#estado_procedimiento').val()) {
      Swal.fire('Atención', 'Complete los campos obligatorios', 'warning');
      return;
    }
    
    const dataProcedimiento = {
      id_consulta: parseInt($('#id_consulta').val()),
      id_paciente: parseInt($('#id_paciente').val()),
      id_tipo_procedimiento: parseInt($('#id_tipo_procedimiento').val()),
      id_profesional: parseInt($('#id_profesional_realizo').val()),
      fecha_procedimiento: $('#fecha_procedimiento').val(),
      descripcion_procedimiento: $('#descripcion_procedimiento').val(),
      resultado_procedimiento: $('#resultado_procedimiento').val() || null,
      estado_procedimiento: $('#estado_procedimiento').val(),
      observaciones: $('#observaciones').val() || null,
      usuario_creacion: 'ADMIN' // Cambiar por usuario real
    };
    
    console.log('📤 Enviando procedimiento:', dataProcedimiento);
    
    fetch('/api/v1/procedimientos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify(dataProcedimiento)
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        $('#tblConsultas').DataTable().ajax.reload();
        $('#modalRegistrarProcedimiento').modal('hide');
        
        Swal.fire({
          icon: 'success',
          title: 'Procedimiento Registrado',
          text: data.data.mensaje,
          confirmButtonText: 'Cerrar'
        });
      } else {
        Swal.fire('Error', data.error || 'No se pudo guardar el procedimiento', 'error');
      }
    })
    .catch(err => {
      console.error('❌ Error:', err);
      Swal.fire('Error', 'Ocurrió un error al guardar el procedimiento', 'error');
    });
  });
}

// ==========================================
// INICIALIZACIÓN
// ==========================================
$(document).ready(function() {
  initDatatable();
  initTiposProcedimientoDatatable();
  initProfesionalesDatatable();
  registrarProcedimiento();
  buscarTipoProcedimiento();
  buscarProfesional();
  guardarProcedimiento();
  
  // Si viene con id_consulta en URL, abrir directamente
  const urlParams = new URLSearchParams(window.location.search);
  const idConsulta = urlParams.get('id_consulta');
  if (idConsulta) {
    setTimeout(() => {
      $(`button[data-id="${idConsulta}"]`).click();
    }, 500);
  }
});
</script>
{% endblock %}