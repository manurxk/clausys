{% extends 'base.html' %}

{% block titulo %}
Mis Consultas del Día
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
    <h3><i class="fas fa-calendar-check"></i> Mis Consultas del Día</h3>
    
    <!-- Tarjeta principal -->
    <div class="card shadow">
        <!-- Header -->
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <button type="button" class="btn btn-outline-light" id="btnHoy">
                    <i class="fas fa-calendar-day"></i> Hoy
                </button>
                <button type="button" class="btn btn-outline-light ml-2" id="btnRefrescar">
                    <i class="fas fa-sync-alt"></i> Refrescar
                </button>
            </div>
            <div>
                <span class="badge badge-light p-2">
                    <i class="fas fa-calendar-day"></i> <span id="fechaHoy"></span>
                </span>
            </div>
        </div>

        <!-- Selector de fecha -->
        <div class="card-body border-bottom">
            <div class="row">
                <div class="col-md-4">
                    <label>Seleccionar Fecha:</label>
                    <input type="date" class="form-control" id="filtroFecha">
                </div>
                <div class="col-md-8">
                    <div class="d-flex align-items-end h-100">
                        <span class="badge badge-primary p-2 mr-2">
                            Total: <span id="totalCitas">0</span>
                        </span>
                        <span class="badge badge-success p-2 mr-2">
                            Completadas: <span id="citasCompletadas">0</span>
                        </span>
                        <span class="badge badge-warning p-2">
                            Pendientes: <span id="citasPendientes">0</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cuerpo con tabla de CITAS -->
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered w-100" id="tblCitas">
                    <thead class="thead-dark">
                        <tr>
                            <th>Hora</th>
                            <th>Paciente</th>
                            <th>HC</th>
                            <th>Tipo Cita</th>
                            <th>Sesión</th>
                            <th>Estado Cita</th>
                            <th>Consulta</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
// ==========================================
// CONSTANTES Y CONFIGURACIÓN
// ==========================================
const CSRFToken = "{{ csrf_token() }}" || null;

// ==========================================
// DATATABLE DE CITAS DEL DÍA
// ==========================================
const initDatatable = () => {
  const fecha = $('#filtroFecha').val() || new Date().toISOString().split('T')[0];
  
  $('#tblCitas').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: `/api/v1/consultas/dia/${ID_ESPECIALISTA}?fecha=${fecha}`,
      dataSrc: function(json) {
        console.log('📋 Citas del día:', json);
        if (json.success) {
          actualizarEstadisticas(json.data);
          return json.data;
        } else {
          console.error('Error del servidor:', json.error);
          Swal.fire('Error', json.error || 'Error al cargar datos', 'error');
          return [];
        }
      },
      error: function(xhr, error, thrown) {
        console.error('Error en AJAX:', xhr.responseText);
        Swal.fire('Error', 'No se pudieron cargar las citas', 'error');
      }
    },
    columns: [
      { 
        data: 'cita_hora_inicio',
        render: function(data, type, row) {
          return `
            <strong style="font-size: 1.1em;">${data}</strong><br>
            <small class="text-muted">${data} - ${row.cita_hora_fin}</small>
          `;
        },
        title: 'Hora'
      },
      { 
        data: 'paciente_nombre',
        render: function(data, type, row) {
          return `
            <strong>${data}</strong><br>
            <small class="text-muted">CI: ${row.paciente_cedula}</small>
          `;
        },
        title: 'Paciente'
      },
      { 
        data: 'historia_clinica',
        title: 'HC',
        className: 'text-center'
      },
      { 
        data: 'cita_tipo',
        render: function(data, type, row) {
          const badges = {
            'PRIMERA_VEZ': '<span class="badge badge-primary">Primera Vez</span>',
            'EVALUACION': '<span class="badge badge-info">Evaluación</span>',
            'TRATAMIENTO': '<span class="badge badge-success">Tratamiento</span>',
            'SEGUIMIENTO': '<span class="badge badge-warning">Seguimiento</span>'
          };
          return badges[data] || data;
        },
        title: 'Tipo',
        className: 'text-center'
      },
      { 
        data: 'cita_numero_sesion',
        render: function(data, type, row) {
          return data ? `<strong>#${data}</strong>` : '-';
        },
        title: 'Sesión',
        className: 'text-center'
      },
      { 
        data: 'estado_cita_nombre',
        render: function(data, type, row) {
          return `<span class="badge" style="background-color: ${row.estado_cita_color}">${data}</span>`;
        },
        title: 'Estado Cita',
        className: 'text-center'
      },
      { 
        data: function(row) {
          if (row.consulta_iniciada) {
            const badges = {
              'completada': '<span class="badge badge-success"><i class="fas fa-check-circle"></i> COMPLETADA</span>',
              'en_curso': '<span class="badge badge-warning"><i class="fas fa-clock"></i> EN CURSO</span>',
              'borrador': '<span class="badge badge-info"><i class="fas fa-edit"></i> BORRADOR</span>'
            };
            return badges[row.consulta_estado] || row.consulta_estado;
          } else {
            return '<span class="badge badge-secondary"><i class="fas fa-minus-circle"></i> Sin iniciar</span>';
          }
        },
        title: 'Consulta',
        className: 'text-center'
      },
      { 
        data: function(row) {
          let botones = '';
          
          // Botón INICIAR o CONTINUAR CONSULTA
          if (row.puede_iniciar) {
            const textoBoton = row.consulta_iniciada ? 'Continuar' : 'Iniciar';
            const iconoBoton = row.consulta_iniciada ? 'fa-edit' : 'fa-play-circle';
            const colorBoton = row.consulta_iniciada ? 'btn-warning' : 'btn-success';
            
            botones += `
              <button type="button" class="btn ${colorBoton} btn-sm mb-1" 
                      onclick="iniciarConsulta(${row.id_cita}, ${row.id_paciente}, ${row.id_consulta || 'null'})"
                      title="${textoBoton} Consulta">
                <i class="fas ${iconoBoton}"></i> ${textoBoton}
              </button>
            `;
          } else {
            botones += `
              <button type="button" class="btn btn-secondary btn-sm mb-1" disabled title="Consulta Finalizada">
                <i class="fas fa-check-circle"></i> Finalizada
              </button>
            `;
          }
          
          // Botón VER DETALLES
          botones += `
            <button type="button" class="btn btn-info btn-sm mb-1 ml-1" 
                    onclick="verDetallesCita(${row.id_cita})"
                    title="Ver Detalles">
              <i class="fas fa-eye"></i>
            </button>
          `;
          
          return botones;
        },
        title: 'Acciones',
        className: 'text-center',
        orderable: false
      }
    ],
    order: [[0, 'asc']], // Ordenar por hora ascendente
    responsive: true,
    pageLength: 25,
    destroy: true // Permitir reinicialización
  });
}

// ==========================================
// ACTUALIZAR ESTADÍSTICAS
// ==========================================
const actualizarEstadisticas = (citas) => {
  $('#totalCitas').text(citas.length);
  
  const completadas = citas.filter(c => c.consulta_estado === 'completada').length;
  const pendientes = citas.filter(c => !c.consulta_iniciada || c.consulta_estado !== 'completada').length;
  
  $('#citasCompletadas').text(completadas);
  $('#citasPendientes').text(pendientes);
}

// ==========================================
// INICIAR/CONTINUAR CONSULTA
// ==========================================

// ==========================================
// VER DETALLES DE LA CITA
// ==========================================
window.verDetallesCita = function(idCita) {
  Swal.fire({
    title: 'Detalles de la Cita',
    html: `
      <div class="text-left">
        <p><strong>ID Cita:</strong> ${idCita}</p>
        <p class="text-muted">Funcionalidad en desarrollo...</p>
      </div>
    `,
    icon: 'info',
    confirmButtonText: 'Cerrar'
  });
}

// ==========================================
// CARGAR CITAS AL CAMBIAR FECHA
// ==========================================
const cargarCitas = () => {
  const tabla = $('#tblCitas').DataTable();
  tabla.destroy();
  initDatatable();
}

// ==========================================
// MOSTRAR FECHA FORMATEADA
// ==========================================
const mostrarFechaHoy = () => {
  const fecha = new Date($('#filtroFecha').val());
  const opciones = { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  };
  const fechaFormateada = fecha.toLocaleDateString('es-ES', opciones);
  $('#fechaHoy').text(fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1));
}

// ==========================================
// AGREGAR EVENTOS
// ==========================================
const addEvents = () => {
  // Cambiar fecha
  $('#filtroFecha').on('change', function() {
    mostrarFechaHoy();
    cargarCitas();
  });
  
  // Botón Hoy
  $('#btnHoy').on('click', function() {
    const hoy = new Date().toISOString().split('T')[0];
    $('#filtroFecha').val(hoy);
    mostrarFechaHoy();
    cargarCitas();
  });
  
  // Botón Refrescar
  $('#btnRefrescar').on('click', function() {
    cargarCitas();
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'success',
      title: 'Citas actualizadas',
      showConfirmButton: false,
      timer: 1500
    });
  });
}

// ==========================================
// INICIALIZACIÓN
// ==========================================
$(document).ready(function() {
  console.log('🚀 Inicializando vista de consultas...');
  
  // Establecer fecha de hoy
  const hoy = new Date().toISOString().split('T')[0];
  $('#filtroFecha').val(hoy);
  mostrarFechaHoy();
  
  // Inicializar DataTable
  initDatatable();
  console.log('✅ DataTable inicializado');
  
  // Activar eventos
  addEvents();
  
  console.log('✅ Vista de consultas completamente inicializada');
});
</script>
{% endblock %}