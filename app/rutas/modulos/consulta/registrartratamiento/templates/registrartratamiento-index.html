{% extends 'base.html' %}

{% block titulo %}
Registrar Tratamiento
{% endblock %}

{% block contenido %}
<div class="container-fluid mt-4">
    <h3><i class="fas fa-pills"></i> Registrar Tratamiento Médico</h3>
    
    <!-- Tarjeta principal -->
    <div class="card shadow">
        <!-- Header -->
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">
                <i class="fas fa-clipboard-list"></i> Consultas con Diagnósticos
            </h5>
        </div>

        <!-- Cuerpo con tabla -->
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered w-100" id="tblConsultas">
                    <thead class="thead-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Paciente</th>
                            <th>HC</th>
                            <th>Profesional</th>
                            <th>Diagnósticos</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registrar Tratamiento -->
<div class="modal fade" id="modalRegistrarTratamiento" tabindex="-1" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h4 class="modal-title">
                    <i class="fas fa-pills"></i> Registrar Tratamiento Médico
                </h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="row">
                    <!-- Columna izquierda: Información y Formulario -->
                    <div class="col-md-8">
                        <!-- Información de la Consulta -->
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <i class="fas fa-info-circle"></i> Información de la Consulta
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Paciente:</strong> <span id="infoPaciente"></span></p>
                                        <p class="mb-1"><strong>HC:</strong> <span id="infoHC"></span></p>
                                        <p class="mb-1"><strong>Fecha Consulta:</strong> <span id="infoFecha"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1"><strong>Profesional:</strong> <span id="infoProfesional"></span></p>
                                        <p class="mb-1"><strong>Estado:</strong> <span id="infoEstado"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form id="formTratamiento">
                            <input type="hidden" id="id_consulta">
                            <input type="hidden" id="id_paciente">

                            <!-- Seleccionar Diagnóstico -->
                            <div class="form-group">
                                <label>Diagnóstico a Tratar: <span class="text-danger">*</span></label>
                                <select class="form-control" id="id_diagnostico" required>
                                    <option value="">Seleccione un diagnóstico...</option>
                                </select>
                                <small class="form-text text-muted">
                                    Seleccione el diagnóstico para el cual se prescribe el tratamiento
                                </small>
                            </div>

                            <!-- Tipo de Tratamiento -->
                            <div class="form-group">
                                <label>Tipo de Tratamiento: <span class="text-danger">*</span></label>
                                <select class="form-control" id="tipo_tratamiento" required>
                                    <option value="">Seleccione...</option>
                                    <option value="FARMACOLOGICO">Farmacológico</option>
                                    <option value="FISIOTERAPIA">Fisioterapia</option>
                                    <option value="QUIRURGICO">Quirúrgico</option>
                                    <option value="PSICOLOGICO">Psicológico</option>
                                    <option value="OTRO">Otro</option>
                                </select>
                            </div>

                            <!-- Nombre del Tratamiento -->
                            <div class="form-group">
                                <label>Nombre del Tratamiento: <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nombre_tratamiento" 
                                       placeholder="Ej: Amoxicilina 500mg, Sesiones de fisioterapia..." 
                                       required>
                            </div>

                            <!-- Descripción/Indicaciones -->
                            <div class="form-group">
                                <label>Descripción e Indicaciones: <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="descripcion_tratamiento" rows="3" 
                                          placeholder="Descripción detallada del tratamiento e indicaciones de uso..." 
                                          required></textarea>
                            </div>

                            <!-- Dosis y Frecuencia -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Dosis:</label>
                                        <input type="text" class="form-control" id="dosis" 
                                               placeholder="Ej: 1 comprimido, 5ml, etc.">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Frecuencia:</label>
                                        <input type="text" class="form-control" id="frecuencia" 
                                               placeholder="Ej: Cada 8 horas, 3 veces al día">
                                    </div>
                                </div>
                            </div>

                            <!-- Fechas -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Fecha de Inicio: <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="fecha_inicio" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Fecha de Fin (estimada):</label>
                                        <input type="date" class="form-control" id="fecha_fin">
                                    </div>
                                </div>
                            </div>

                            <!-- Duración estimada -->
                            <div class="form-group">
                                <label>Duración Estimada (días):</label>
                                <input type="number" class="form-control" id="duracion_dias" 
                                       placeholder="Ej: 7, 15, 30..." min="1">
                                <small class="form-text text-muted">
                                    Si completa este campo, la fecha de fin se calculará automáticamente
                                </small>
                            </div>

                            <!-- Estado del Tratamiento -->
                            <div class="form-group">
                                <label>Estado del Tratamiento: <span class="text-danger">*</span></label>
                                <select class="form-control" id="estado_tratamiento" required>
                                    <option value="ACTIVO" selected>Activo</option>
                                    <option value="SUSPENDIDO">Suspendido</option>
                                    <option value="FINALIZADO">Finalizado</option>
                                </select>
                            </div>

                            <!-- Observaciones -->
                            <div class="form-group">
                                <label>Observaciones:</label>
                                <textarea class="form-control" id="observaciones" rows="2" 
                                          placeholder="Observaciones adicionales, precauciones, contraindicaciones..."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Columna derecha: Tratamientos Activos del Paciente -->
                    <div class="col-md-4">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-history"></i> Tratamientos del Paciente
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <div id="listaTratamientos">
                                    <p class="text-muted text-center">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnGuardarTratamiento">
                    <i class="fas fa-save"></i> Guardar Tratamiento
                </button>
            </div>
        </div>
    </div>
</div>

<style>
#tblConsultas tbody tr {
    cursor: pointer;
}

#tblConsultas tbody tr:hover {
    background-color: #fff3cd;
}

.tratamiento-item {
    padding: 10px;
    border-left: 3px solid #ffc107;
    margin-bottom: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.tratamiento-item.ACTIVO {
    border-left-color: #28a745;
}

.tratamiento-item.SUSPENDIDO {
    border-left-color: #dc3545;
}

.tratamiento-item.FINALIZADO {
    border-left-color: #6c757d;
}

.tratamiento-item h6 {
    margin-bottom: 5px;
    font-size: 14px;
}

.tratamiento-item small {
    font-size: 11px;
}
</style>

{% endblock %}

{% block js %}
<script>
const CSRFToken = "{{ csrf_token() }}" || null;

// ==========================================
// DATATABLE DE CONSULTAS
// ==========================================
const initDatatable = () => {
  $('#tblConsultas').DataTable({
    language: {
      url: "{{ url_for('static', filename='vendor/datatables/es-ES.json') }}",
    },
    ajax: {
      url: '/api/v1/consultas',
      dataSrc: function(json) {
        if (json.success) {
          return json.data;
        } else {
          Swal.fire('Error', json.error || 'Error al cargar consultas', 'error');
          return [];
        }
      },
      error: function(xhr, error, thrown) {
        console.error('Error en AJAX:', xhr.responseText);
        Swal.fire('Error', 'No se pudieron cargar las consultas', 'error');
      }
    },
    columns: [
      { 
        data: 'consulta_fecha',
        render: function(data) {
          return data ? data.split(' ')[0] : 'N/A';
        }
      },
      { 
        data: 'consulta_fecha',
        render: function(data) {
          return data ? data.split(' ')[1] : 'N/A';
        }
      },
      { data: 'paciente_nombre' },
      { data: 'historia_clinica' },
      { data: 'profesional_nombre' },
      { 
        data: 'id_consulta',
        render: function(data, type, row) {
          return `<span class="badge badge-info cursor-pointer" onclick="verDiagnosticos(${data})">
                    Ver Diagnósticos
                  </span>`;
        },
        className: 'text-center'
      },
      { 
        data: 'consulta_estado',
        render: function(data) {
          const badges = {
            'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
            'EN_ATENCION': '<span class="badge badge-info">En Atención</span>',
            'FINALIZADA': '<span class="badge badge-success">Finalizada</span>'
          };
          return badges[data] || data;
        },
        className: 'text-center'
      },
      { 
        data: function(row) {
          return `
            <button type="button" class="btn btn-warning btn-sm btn-registrar-tratamiento" 
                    data-id="${row.id_consulta}" 
                    data-id-paciente="${row.id_paciente}"
                    data-paciente="${row.paciente_nombre}"
                    data-hc="${row.historia_clinica}"
                    data-profesional="${row.profesional_nombre}"
                    data-fecha="${row.consulta_fecha}"
                    data-estado="${row.consulta_estado}"
                    title="Registrar Tratamiento">
              <i class="fas fa-plus-circle"></i> Agregar Tratamiento
            </button>
          `;
        },
        className: 'text-center',
        orderable: false
      }
    ],
    order: [[0, 'desc'], [1, 'desc']],
    responsive: true,
    pageLength: 10
  });
}

// ==========================================
// VER DIAGNÓSTICOS (FUNCIÓN AUXILIAR)
// ==========================================
window.verDiagnosticos = (idConsulta) => {
  fetch(`/api/v1/diagnosticos/consulta/${idConsulta}`)
    .then(resp => resp.json())
    .then(data => {
      if (data.success && data.data.length > 0) {
        let html = '<ul>';
        data.data.forEach(d => {
          html += `<li><strong>${d.codigo_cie10}:</strong> ${d.descripcion}</li>`;
        });
        html += '</ul>';
        Swal.fire({
          title: 'Diagnósticos de la Consulta',
          html: html,
          icon: 'info'
        });
      } else {
        Swal.fire('Sin diagnósticos', 'Esta consulta no tiene diagnósticos registrados', 'info');
      }
    });
}

// ==========================================
// ABRIR MODAL Y PRE-CARGAR DATOS
// ==========================================
const registrarTratamiento = () => {
  $('#tblConsultas').on('click', '.btn-registrar-tratamiento', function() {
    const data = $(this).data();
    
    // Llenar información de la consulta
    $('#infoPaciente').text(data.paciente);
    $('#infoHC').text(data.hc);
    $('#infoFecha').text(data.fecha);
    $('#infoProfesional').text(data.profesional);
    $('#infoEstado').html($(this).closest('tr').find('td:eq(6)').html());
    
    // Llenar campos ocultos
    $('#id_consulta').val(data.id);
    $('#id_paciente').val(data.idPaciente);
    
    // Pre-cargar fecha de inicio (hoy)
    const hoy = new Date().toISOString().split('T')[0];
    $('#fecha_inicio').val(hoy);
    
    // Limpiar formulario
    $('#id_diagnostico').html('<option value="">Seleccione un diagnóstico...</option>');
    $('#tipo_tratamiento').val('');
    $('#nombre_tratamiento').val('');
    $('#descripcion_tratamiento').val('');
    $('#dosis').val('');
    $('#frecuencia').val('');
    $('#fecha_fin').val('');
    $('#duracion_dias').val('');
    $('#observaciones').val('');
    $('#estado_tratamiento').val('ACTIVO');
    
    // Cargar diagnósticos de la consulta
    cargarDiagnosticosConsulta(data.id);
    
    // Cargar tratamientos del paciente
    cargarTratamientosPaciente(data.idPaciente);
    
    // Abrir modal
    $('#modalRegistrarTratamiento').modal('show');
  });
}

// ==========================================
// CARGAR DIAGNÓSTICOS DE LA CONSULTA
// ==========================================
const cargarDiagnosticosConsulta = (idConsulta) => {
  fetch(`/api/v1/diagnosticos/consulta/${idConsulta}`)
    .then(resp => resp.json())
    .then(data => {
      if (data.success && data.data.length > 0) {
        let html = '<option value="">Seleccione un diagnóstico...</option>';
        data.data.forEach(diag => {
          html += `<option value="${diag.id_registro_diagnostico}">
                     ${diag.codigo_cie10} - ${diag.descripcion} (${diag.tipo})
                   </option>`;
        });
        $('#id_diagnostico').html(html);
      } else {
        $('#id_diagnostico').html('<option value="">No hay diagnósticos registrados</option>');
        Swal.fire('Sin diagnósticos', 'Esta consulta no tiene diagnósticos. Debe registrar un diagnóstico primero.', 'warning');
      }
    })
    .catch(err => {
      console.error('Error cargando diagnósticos:', err);
    });
}

// ==========================================
// CARGAR TRATAMIENTOS DEL PACIENTE
// ==========================================
const cargarTratamientosPaciente = (idPaciente) => {
  $('#listaTratamientos').html('<p class="text-muted text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>');
  
  fetch(`/api/v1/tratamientos/paciente/${idPaciente}`)
    .then(resp => resp.json())
    .then(data => {
      if (data.success && data.data.length > 0) {
        let html = '';
        data.data.forEach(trat => {
          html += `
            <div class="tratamiento-item ${trat.estado}">
              <h6>${trat.nombre}</h6>
              <small>
                <strong>Tipo:</strong> ${trat.tipo}<br>
                <strong>Inicio:</strong> ${trat.fecha_inicio}<br>
                ${trat.fecha_fin ? `<strong>Fin:</strong> ${trat.fecha_fin}<br>` : ''}
                <span class="badge badge-sm badge-secondary">${trat.estado}</span>
              </small>
            </div>
          `;
        });
        $('#listaTratamientos').html(html);
      } else {
        $('#listaTratamientos').html('<p class="text-muted text-center">Sin tratamientos previos</p>');
      }
    })
    .catch(err => {
      console.error('Error cargando tratamientos:', err);
      $('#listaTratamientos').html('<p class="text-danger text-center">Error al cargar</p>');
    });
}

// ==========================================
// CALCULAR FECHA FIN AUTOMÁTICAMENTE
// ==========================================
const calcularFechaFin = () => {
  $('#duracion_dias').on('input', function() {
    const duracion = parseInt($(this).val());
    const fechaInicio = $('#fecha_inicio').val();
    
    if (duracion > 0 && fechaInicio) {
      const fecha = new Date(fechaInicio + 'T00:00:00');
      fecha.setDate(fecha.getDate() + duracion);
      
      const fechaFin = fecha.toISOString().split('T')[0];
      $('#fecha_fin').val(fechaFin);
    }
  });
  
  $('#fecha_inicio').on('change', function() {
    const duracion = parseInt($('#duracion_dias').val());
    if (duracion > 0) {
      $('#duracion_dias').trigger('input');
    }
  });
}

// ==========================================
// GUARDAR TRATAMIENTO
// ==========================================
const guardarTratamiento = () => {
  $('#btnGuardarTratamiento').on('click', function() {
    // Validar campos obligatorios
    if (!$('#id_diagnostico').val() || !$('#tipo_tratamiento').val() || 
        !$('#nombre_tratamiento').val() || !$('#descripcion_tratamiento').val() || 
        !$('#fecha_inicio').val() || !$('#estado_tratamiento').val()) {
      Swal.fire('Atención', 'Complete los campos obligatorios', 'warning');
      return;
    }
    
    const dataTratamiento = {
      id_consulta: parseInt($('#id_consulta').val()),
      id_paciente: parseInt($('#id_paciente').val()),
      id_diagnostico: parseInt($('#id_diagnostico').val()),
      tipo_tratamiento: $('#tipo_tratamiento').val(),
      nombre_tratamiento: $('#nombre_tratamiento').val(),
      descripcion_tratamiento: $('#descripcion_tratamiento').val(),
      dosis: $('#dosis').val() || null,
      frecuencia: $('#frecuencia').val() || null,
      fecha_inicio: $('#fecha_inicio').val(),
      fecha_fin: $('#fecha_fin').val() || null,
      duracion_dias: parseInt($('#duracion_dias').val()) || null,
      estado_tratamiento: $('#estado_tratamiento').val(),
      observaciones: $('#observaciones').val() || null,
      usuario_creacion: 'ADMIN' // Cambiar por usuario real
    };
    
    console.log('📤 Enviando tratamiento:', dataTratamiento);
    
    fetch('/api/v1/tratamientos', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRFToken
      },
      body: JSON.stringify(dataTratamiento)
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.success) {
        $('#tblConsultas').DataTable().ajax.reload();
        $('#modalRegistrarTratamiento').modal('hide');
        
        Swal.fire({
          icon: 'success',
          title: 'Tratamiento Registrado',
          text: data.data.mensaje,
          confirmButtonText: 'Cerrar'
        });
      } else {
        Swal.fire('Error', data.error || 'No se pudo guardar el tratamiento', 'error');
      }
    })
    .catch(err => {
      console.error('❌ Error:', err);
      Swal.fire('Error', 'Ocurrió un error al guardar el tratamiento', 'error');
    });
  });
}

// ==========================================
// INICIALIZACIÓN
// ==========================================
$(document).ready(function() {
  initDatatable();
  registrarTratamiento();
  calcularFechaFin();
  guardarTratamiento();
  
  // Si viene con id_consulta en URL, abrir directamente
  const urlParams = new URLSearchParams(window.location.search);
  const idConsulta = urlParams.get('id_consulta');
  if (idConsulta) {
    setTimeout(() => {
      $(`button[data-id="${idConsulta}"]`).click();
    }, 500);
  }
});
</script>
{% endblock %}